<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DangleData - NHL Player Line Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎯</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-gradient-start: #1e3c72;
            --bg-gradient-end: #2a5298;
            --container-bg: white;
            --text-primary: #1e3c72;
            --text-secondary: #666;
            --card-bg: #f8f9fa;
            --card-hover-border: #2a5298;
            --button-bg: white;
            --button-text: #2a5298;
            --button-active-bg: #2a5298;
            --button-active-text: white;
            --modal-overlay: rgba(0,0,0,0.7);
            --table-header-bg: #2a5298;
            --table-border: #ddd;
            --input-border: #ddd;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --hit-bg: #d4edda;
            --miss-bg: #f8d7da;
        }
        
        body.dark-mode {
            --bg-gradient-start: #0a1929;
            --bg-gradient-end: #1a2332;
            --container-bg: #1e2936;
            --text-primary: #e3f2fd;
            --text-secondary: #b0bec5;
            --card-bg: #263238;
            --card-hover-border: #4fc3f7;
            --button-bg: #263238;
            --button-text: #4fc3f7;
            --button-active-bg: #4fc3f7;
            --button-active-text: #0a1929;
            --modal-overlay: rgba(0,0,0,0.85);
            --table-header-bg: #1565c0;
            --table-border: #37474f;
            --input-border: #37474f;
            --warning-bg: #3e2723;
            --warning-text: #ffb74d;
            --success-bg: #1b5e20;
            --success-text: #81c784;
            --error-bg: #b71c1c;
            --error-text: #ef5350;
            --hit-bg: #2e7d32;
            --miss-bg: #c62828;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        h1 {
            color: var(--text-primary);
            font-size: 2.5em;
            transition: color 0.3s ease;
        }
        
        .dark-mode-toggle {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .dark-mode-toggle:hover {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }
        
        .api-status {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        input[type="text"], input[type="checkbox"], select {
            padding: 10px;
            font-size: 16px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            background: var(--container-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        select {
            cursor: pointer;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .stat-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stat-button {
            padding: 12px 24px;
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stat-button:hover {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .stat-button.active {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        #playersContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .player-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .player-card:hover {
            border-color: var(--card-hover-border);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }
        
        .player-team {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: var(--container-bg);
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .trend-hot {
            background: var(--success-bg);
            color: var(--success-text);
        }
        
        .trend-cold {
            background: var(--error-bg);
            color: var(--error-text);
        }
        
        .trend-neutral {
            background: var(--card-bg);
            color: var(--text-secondary);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-primary);
            font-size: 1.2em;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-overlay);
        }
        
        .modal-content {
            background-color: var(--container-bg);
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        
        .close {
            color: var(--text-secondary);
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: var(--text-primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--table-border);
            transition: all 0.3s ease;
        }
        
        th {
            background: var(--table-header-bg);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: var(--card-bg);
        }
        
        .hit-cell {
            background: var(--hit-bg);
            color: var(--success-text);
            font-weight: 600;
        }
        
        .miss-cell {
            background: var(--miss-bg);
            color: var(--error-text);
        }
        
        /* Watchlist Styles */
        .watchlist-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: var(--container-bg);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .watchlist-container.minimized {
            max-height: 50px;
        }
        
        .watchlist-header {
            background: var(--table-header-bg);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .watchlist-content {
            padding: 15px;
            max-height: 430px;
            overflow-y: auto;
        }
        
        .watchlist-container.minimized .watchlist-content {
            display: none;
        }
        
        .watchlist-item {
            background: var(--card-bg);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .watchlist-item:hover {
            border-color: var(--card-hover-border);
        }
        
        .watchlist-item.selected {
            border-color: var(--button-active-bg);
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .watchlist-item-remove {
            background: var(--error-bg);
            color: var(--error-text);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .watchlist-empty {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-style: italic;
        }
        
        .parlay-calculator {
            background: var(--success-bg);
            color: var(--success-text);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .parlay-odds {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .betting-line {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .favorite-star {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.3s;
        }
        
        .favorite-star.active {
            opacity: 1;
            color: gold;
        }
        
        .favorite-star:hover {
            opacity: 1;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>🏒 DangleData</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">🌙 Dark Mode</button>
        </div>
        
        <p class="subtitle">NHL Player Line Tracker - Protected Backend Edition</p>
        
        <div id="apiStatus" class="api-status" style="display:none"></div>
        
        <div class="controls">
            <div class="control-group">
                <label>
                    <input type="checkbox" id="goalieMode" onchange="toggleGoalieMode()">
                    Goalie Mode
                </label>
            </div>
            
            <div class="control-group">
                <label>Min Games:</label>
                <input type="number" id="minGames" value="5" min="1" max="50" style="width: 80px;" onchange="loadData()">
            </div>
            
            <div class="control-group">
                <label>Search:</label>
                <input type="text" id="searchPlayer" placeholder="Player name..." oninput="loadData()">
            </div>
            
            <div class="control-group">
                <label>Sort By:</label>
                <select id="sortBy" onchange="loadData()">
                    <option value="trend">Trend</option>
                    <option value="hitRate">Hit Rate</option>
                    <option value="last5">Last 5 Games</option>
                    <option value="stat">Season Stats</option>
                    <option value="name">Name</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="favoritesOnly" onchange="loadData()">
                    Favorites Only
                </label>
            </div>
        </div>
        
        <div class="stat-buttons" id="statButtons">
            <button class="stat-button active" onclick="selectStat('points')">Points</button>
            <button class="stat-button" onclick="selectStat('goals')">Goals</button>
            <button class="stat-button" onclick="selectStat('assists')">Assists</button>
            <button class="stat-button" onclick="selectStat('shots')">Shots</button>
        </div>
        
        <div id="playersContainer">
            <div class="loading">Loading players...</div>
        </div>
    </div>
    
    <!-- Watchlist -->
    <div id="watchlistContainer" class="watchlist-container">
        <div class="watchlist-header" onclick="toggleWatchlist()">
            <div>⭐ Watchlist <span id="watchlistCount">(0)</span></div>
            <div>▼</div>
        </div>
        <div class="watchlist-content">
            <div id="watchlistItems"></div>
            <div id="parlayCalculator"></div>
        </div>
    </div>
    
    <!-- Game Log Modal -->
    <div id="gameLogModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
        
        let currentStat = 'points';
        let isGoalieMode = false;
        let watchlist = [];
        let selectedParlayPlayers = [];
        let lastUpdated = null;
        
        // Load preferences
        function loadPreferences() {
            // Load dark mode
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '☀️ Light Mode';
            }
            
            // Load watchlist
            const saved = localStorage.getItem('nhlWatchlist');
            if (saved) {
                try {
                    watchlist = JSON.parse(saved);
                    updateWatchlistDisplay();
                } catch (e) {
                    watchlist = [];
                }
            }
            
            // Load minimized state
            const isMinimized = localStorage.getItem('watchlistMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('watchlistContainer').classList.add('minimized');
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            const btn = document.querySelector('.dark-mode-toggle');
            btn.textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
        }
        
        // Toggle goalie mode
        function toggleGoalieMode() {
            isGoalieMode = document.getElementById('goalieMode').checked;
            
            // Update stat buttons
            const buttons = document.getElementById('statButtons');
            if (isGoalieMode) {
                buttons.innerHTML = `
                    <button class="stat-button active" onclick="selectStat('saves')">Saves</button>
                    <button class="stat-button" onclick="selectStat('savePct')">Save %</button>
                    <button class="stat-button" onclick="selectStat('shotsAgainst')">Shots Against</button>
                `;
                currentStat = 'saves';
            } else {
                buttons.innerHTML = `
                    <button class="stat-button active" onclick="selectStat('points')">Points</button>
                    <button class="stat-button" onclick="selectStat('goals')">Goals</button>
                    <button class="stat-button" onclick="selectStat('assists')">Assists</button>
                    <button class="stat-button" onclick="selectStat('shots')">Shots</button>
                `;
                currentStat = 'points';
            }
            
            loadData();
        }
        
        // Select stat
        function selectStat(stat) {
            currentStat = stat;
            document.querySelectorAll('.stat-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadData();
        }
        
        // Load data from backend API
        async function loadData() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '<div class="loading">Loading...</div>';
            
            const minGames = document.getElementById('minGames').value;
            const searchName = document.getElementById('searchPlayer').value;
            const sortBy = document.getElementById('sortBy').value;
            const favoritesOnly = document.getElementById('favoritesOnly').checked;
            
            try {
                const endpoint = isGoalieMode ? '/api/goalies' : '/api/players';
                const params = new URLSearchParams({
                    stat: currentStat,
                    minGames: minGames,
                    searchName: searchName,
                    sortBy: sortBy
                });
                
                // Add favorites filter if enabled
                if (favoritesOnly) {
                    const favorites = getFavorites();
                    if (favorites.length === 0) {
                        container.innerHTML = '<div class="loading">No favorites added yet. Click stars on player cards to add favorites!</div>';
                        return;
                    }
                    params.append('favorites', favorites.join(','));
                }
                
                const response = await fetch(`${API_BASE}${endpoint}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                lastUpdated = data.meta.lastUpdated;
                
                const players = isGoalieMode ? data.goalies : data.players;
                
                if (players.length === 0) {
                    container.innerHTML = '<div class="loading">No players found matching your criteria.</div>';
                    return;
                }
                
                displayPlayers(players);
                
                // Update API status
                const statusEl = document.getElementById('apiStatus');
                statusEl.textContent = `✅ Loaded ${players.length} ${isGoalieMode ? 'goalies' : 'players'} | Last updated: ${new Date(lastUpdated).toLocaleString()}`;
                statusEl.style.display = 'block';
                statusEl.style.background = 'var(--success-bg)';
                statusEl.style.color = 'var(--success-text)';
                
            } catch (error) {
                console.error('Error loading data:', error);
                container.innerHTML = `<div class="loading" style="color: var(--error-text);">❌ Error loading data: ${error.message}</div>`;
                
                const statusEl = document.getElementById('apiStatus');
                statusEl.textContent = `❌ Failed to load data. Make sure API endpoints are deployed to Vercel.`;
                statusEl.style.display = 'block';
            }
        }
        
        // Display players
        function displayPlayers(players) {
            const container = document.getElementById('playersContainer');
            
            const cardsHtml = players.map(player => {
                const trendIcon = player.trend > 10 ? '📈' : player.trend < -10 ? '📉' : '➡️';
                const trendClass = player.trend > 10 ? 'trend-hot' : player.trend < -10 ? 'trend-cold' : 'trend-neutral';
                const isFavorite = isFavorited(player.playerId);
                
                let bettingLineHtml = '';
                if (player.bettingLine) {
                    const odds = player.bettingLine.odds > 0 ? `+${player.bettingLine.odds}` : player.bettingLine.odds;
                    bettingLineHtml = `
                        <div class="betting-line">
                            📊 Line: ${player.bettingLine.line} @ ${odds}
                            ${player.bettingLine.game ? `<br><small>${player.bettingLine.game}</small>` : ''}
                        </div>
                    `;
                }
                
                let nextOpponentHtml = '';
                if (player.nextOpponent) {
                    nextOpponentHtml = `
                        <div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);">
                            🎯 Next: vs ${player.nextOpponent.team}
                            ${player.nextOpponent.defensiveRank ? ` | Rank #${player.nextOpponent.defensiveRank}` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="player-card" onclick="showGameLog(${player.playerId})">
                        <span class="favorite-star ${isFavorite ? 'active' : ''}" 
                              onclick="event.stopPropagation(); toggleFavorite(${player.playerId})">⭐</span>
                        
                        <div class="player-name">${player.name}</div>
                        <div class="player-team">${player.team} • ${player.position} • ${player.gamesPlayed} GP</div>
                        
                        <div class="stat-row">
                            <span><strong>Hit Rate:</strong></span>
                            <span>${player.hitRate}%</span>
                        </div>
                        
                        <div class="stat-row">
                            <span><strong>Trend:</strong></span>
                            <span class="trend-indicator ${trendClass}">${trendIcon} ${Math.abs(player.trend)}%</span>
                        </div>
                        
                        <div class="stat-row">
                            <span><strong>Last 5:</strong></span>
                            <span>${player.last5Rate}%</span>
                        </div>
                        
                        <div class="stat-row">
                            <span><strong>Last 10:</strong></span>
                            <span>${player.last10Rate}%</span>
                        </div>
                        
                        ${bettingLineHtml}
                        ${nextOpponentHtml}
                        
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--table-border); font-size: 0.85em; color: var(--text-secondary);">
                            ${isGoalieMode ? 
                                `Season: ${(player.seasonStats.savePct * 100).toFixed(1)}% SV | ${player.seasonStats.goalsAgainstAverage.toFixed(2)} GAA` :
                                `Season: ${player.seasonStats.goals}G ${player.seasonStats.assists}A ${player.seasonStats.points}P`
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = cardsHtml;
        }
        
        // Show game log modal
        async function showGameLog(playerId) {
            const modal = document.getElementById('gameLogModal');
            const modalBody = document.getElementById('modalBody');
            
            modalBody.innerHTML = '<div class="loading">Loading player details...</div>';
            modal.style.display = 'block';
            
            try {
                const type = isGoalieMode ? 'goalie' : 'skater';
                const response = await fetch(`${API_BASE}/api/player-details?playerId=${playerId}&type=${type}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load player details: ${response.status}`);
                }
                
                const data = await response.json();
                displayGameLog(data);
                
            } catch (error) {
                modalBody.innerHTML = `<div style="color: var(--error-text);">❌ Error: ${error.message}</div>`;
            }
        }
        
        // Display game log in modal
        function displayGameLog(data) {
            const modalBody = document.getElementById('modalBody');
            const player = data.player;
            const games = data.games || [];
            const h2hStats = data.h2hStats;
            const opponentInfo = data.opponentInfo;
            
            let h2hHtml = '';
            if (h2hStats && h2hStats.gamesPlayed > 0) {
                h2hHtml = `
                    <div style="background: var(--success-bg); color: var(--success-text); padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h3>📊 Head-to-Head Stats</h3>
                        <p><strong>Games Played:</strong> ${h2hStats.gamesPlayed}</p>
                        ${h2hStats.stats.avgGoals ? `<p><strong>Avg Goals:</strong> ${h2hStats.stats.avgGoals}</p>` : ''}
                        ${h2hStats.stats.avgAssists ? `<p><strong>Avg Assists:</strong> ${h2hStats.stats.avgAssists}</p>` : ''}
                        ${h2hStats.stats.avgPoints ? `<p><strong>Avg Points:</strong> ${h2hStats.stats.avgPoints}</p>` : ''}
                        ${h2hStats.stats.avgSaves ? `<p><strong>Avg Saves:</strong> ${h2hStats.stats.avgSaves}</p>` : ''}
                        ${h2hStats.hitRate ? `<p><strong>Hit Rate:</strong> ${h2hStats.hitRate}%</p>` : ''}
                    </div>
                `;
            }
            
            let opponentHtml = '';
            if (opponentInfo) {
                opponentHtml = `
                    <div style="background: var(--warning-bg); color: var(--warning-text); padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h3>🎯 Opponent Analysis</h3>
                        <p><strong>Team:</strong> ${opponentInfo.teamName}</p>
                        <p><strong>Shots For/Game:</strong> ${opponentInfo.shotsPerGame} (Rank #${opponentInfo.offensiveRank})</p>
                        <p><strong>Shots Against/Game:</strong> ${opponentInfo.shotsAgainstPerGame} (Rank #${opponentInfo.defensiveRank})</p>
                    </div>
                `;
            }
            
            const isGoalie = player.position === 'G';
            
            let seasonStatsHtml = '';
            if (isGoalie) {
                seasonStatsHtml = `
                    <p><strong>Record:</strong> ${data.seasonStats.wins}-${data.seasonStats.losses}-${data.seasonStats.otLosses}</p>
                    <p><strong>Save %:</strong> ${(data.seasonStats.savePct * 100).toFixed(1)}%</p>
                    <p><strong>GAA:</strong> ${data.seasonStats.goalsAgainstAverage.toFixed(2)}</p>
                    <p><strong>Shutouts:</strong> ${data.seasonStats.shutouts}</p>
                `;
            } else {
                seasonStatsHtml = `
                    <p><strong>Goals:</strong> ${data.seasonStats.goals}</p>
                    <p><strong>Assists:</strong> ${data.seasonStats.assists}</p>
                    <p><strong>Points:</strong> ${data.seasonStats.points}</p>
                    <p><strong>Shots:</strong> ${data.seasonStats.shots}</p>
                    <p><strong>PPG:</strong> ${data.seasonStats.pointsPerGame.toFixed(2)}</p>
                `;
            }
            
            const gameRows = games.slice(0, 20).map(game => {
                const date = new Date(game.gameDate).toLocaleDateString();
                
                if (isGoalie) {
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${game.opponent}</td>
                            <td>${game.decision || '-'}</td>
                            <td>${game.saves}</td>
                            <td>${game.shotsAgainst}</td>
                            <td>${(game.savePct * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${game.opponent}</td>
                            <td>${game.goals}</td>
                            <td>${game.assists}</td>
                            <td>${game.points}</td>
                            <td>${game.shots}</td>
                        </tr>
                    `;
                }
            }).join('');
            
            modalBody.innerHTML = `
                <h2>${player.name}</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    ${player.team} • ${player.position} • ${player.gamesPlayed} GP
                </p>
                
                <h3>Season Stats</h3>
                <div style="margin-bottom: 20px;">
                    ${seasonStatsHtml}
                </div>
                
                ${h2hHtml}
                ${opponentHtml}
                
                <h3>Last ${Math.min(20, games.length)} Games</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            ${isGoalie ? `
                                <th>Decision</th>
                                <th>Saves</th>
                                <th>SA</th>
                                <th>SV%</th>
                            ` : `
                                <th>G</th>
                                <th>A</th>
                                <th>P</th>
                                <th>S</th>
                            `}
                        </tr>
                    </thead>
                    <tbody>
                        ${gameRows}
                    </tbody>
                </table>
            `;
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('gameLogModal').style.display = 'none';
        }
        
        // Favorites management
        function getFavorites() {
            const saved = localStorage.getItem('nhlFavorites');
            return saved ? JSON.parse(saved) : [];
        }
        
        function saveFavorites(favorites) {
            localStorage.setItem('nhlFavorites', JSON.stringify(favorites));
        }
        
        function isFavorited(playerId) {
            return getFavorites().includes(playerId);
        }
        
        function toggleFavorite(playerId) {
            let favorites = getFavorites();
            if (favorites.includes(playerId)) {
                favorites = favorites.filter(id => id !== playerId);
            } else {
                favorites.push(playerId);
            }
            saveFavorites(favorites);
            loadData(); // Reload to update star display
        }
        
        // Watchlist management
        function toggleWatchlist() {
            const container = document.getElementById('watchlistContainer');
            container.classList.toggle('minimized');
            localStorage.setItem('watchlistMinimized', container.classList.contains('minimized'));
        }
        
        function updateWatchlistDisplay() {
            const container = document.getElementById('watchlistItems');
            const countSpan = document.getElementById('watchlistCount');
            
            countSpan.textContent = `(${watchlist.length})`;
            
            if (watchlist.length === 0) {
                container.innerHTML = '<div class="watchlist-empty">⭐ Click stars to add players</div>';
                return;
            }
            
            const itemsHtml = watchlist.map(item => `
                <div class="watchlist-item">
                    <div>
                        <div style="font-weight: 600;">${item.playerName}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">${item.statType}</div>
                    </div>
                    <button class="watchlist-item-remove" onclick="removeFromWatchlist(${item.playerId})">✕</button>
                </div>
            `).join('');
            
            container.innerHTML = itemsHtml;
        }
        
        function removeFromWatchlist(playerId) {
            watchlist = watchlist.filter(item => item.playerId !== playerId);
            localStorage.setItem('nhlWatchlist', JSON.stringify(watchlist));
            updateWatchlistDisplay();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('gameLogModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPreferences();
            loadData();
        });
    </script>
</body>
</html>
