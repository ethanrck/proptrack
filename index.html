<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DangleData - NHL Player Line Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎯</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-gradient-start: #1e3c72;
            --bg-gradient-end: #2a5298;
            --container-bg: white;
            --text-primary: #1e3c72;
            --text-secondary: #666;
            --card-bg: #f8f9fa;
            --card-hover-border: #2a5298;
            --button-bg: white;
            --button-text: #2a5298;
            --button-active-bg: #2a5298;
            --button-active-text: white;
            --modal-overlay: rgba(0,0,0,0.7);
            --table-header-bg: #2a5298;
            --table-border: #ddd;
            --input-border: #ddd;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --hit-bg: #d4edda;
            --miss-bg: #f8d7da;
        }
        
        body.dark-mode {
            --bg-gradient-start: #0a1929;
            --bg-gradient-end: #1a2332;
            --container-bg: #1e2936;
            --text-primary: #e3f2fd;
            --text-secondary: #b0bec5;
            --card-bg: #263238;
            --card-hover-border: #4fc3f7;
            --button-bg: #263238;
            --button-text: #4fc3f7;
            --button-active-bg: #4fc3f7;
            --button-active-text: #0a1929;
            --modal-overlay: rgba(0,0,0,0.85);
            --table-header-bg: #1565c0;
            --table-border: #37474f;
            --input-border: #37474f;
            --warning-bg: #3e2723;
            --warning-text: #ffb74d;
            --success-bg: #1b5e20;
            --success-text: #81c784;
            --error-bg: #b71c1c;
            --error-text: #ef5350;
            --hit-bg: #2e7d32;
            --miss-bg: #c62828;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        h1 {
            color: var(--text-primary);
            font-size: 2.5em;
            transition: color 0.3s ease;
        }
        
        .dark-mode-toggle {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .dark-mode-toggle:hover {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }
        
        .api-status {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        input[type="text"], input[type="checkbox"], select {
            padding: 10px;
            font-size: 16px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            background: var(--container-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        select {
            cursor: pointer;
        }
        
        select option {
            background: var(--container-bg);
            color: var(--text-primary);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .stat-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stat-button {
            padding: 12px 24px;
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stat-button:hover {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .stat-button.active {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        #playersContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .player-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .player-card:hover {
            border-color: var(--card-hover-border);
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .player-info h3 {
            color: var(--text-primary);
            font-size: 1.2em;
            margin-bottom: 5px;
        }
        
        .player-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .favorite-star {
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }
        
        .favorite-star:hover {
            transform: scale(1.2);
        }
        
        .stat-highlight {
            font-size: 2em;
            font-weight: bold;
            color: var(--button-active-bg);
            margin: 15px 0;
        }
        
        .hit-rate-section {
            margin: 15px 0;
        }
        
        .hit-rate-bar-container {
            background: var(--input-border);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .hit-rate-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--button-active-bg), var(--card-hover-border));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .trend-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .trend-up {
            background: var(--success-bg);
            color: var(--success-text);
        }
        
        .trend-down {
            background: var(--error-bg);
            color: var(--error-text);
        }
        
        .trend-neutral {
            background: var(--warning-bg);
            color: var(--warning-text);
        }
        
        .betting-line {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .opponent-analysis {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .recent-games {
            margin-top: 15px;
            font-size: 0.85em;
        }
        
        .recent-games-header {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .game-result {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--input-border);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
        }
        
        .modal-content {
            background-color: var(--container-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .close {
            color: var(--text-secondary);
            float: right;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: var(--text-primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--container-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        thead {
            background: var(--table-header-bg);
            color: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--table-border);
        }
        
        tbody tr:hover {
            background: var(--card-bg);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        
        .error {
            background: var(--error-bg);
            color: var(--error-text);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .hit-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .hit {
            background: var(--hit-bg);
            color: var(--success-text);
        }
        
        .miss {
            background: var(--miss-bg);
            color: var(--error-text);
        }
        
        .rank-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 8px;
        }
        
        .rank-easy {
            background: #27ae60;
            color: white;
        }
        
        .rank-medium {
            background: #f39c12;
            color: white;
        }
        
        .rank-hard {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>🏒 DangleData</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">🌙 Toggle Dark Mode</button>
        </div>
        
        <p class="subtitle">NHL Player Line Tracker - Find the best betting opportunities</p>
        
        <div id="statusMessage" class="api-status" style="display:none;"></div>
        
        <div class="controls">
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showGoalies" onchange="toggleGoalies()">
                    Show Goalies
                </label>
            </div>
            
            <div class="control-group">
                <label for="statType">Stat:</label>
                <select id="statType" onchange="updateStatType()">
                    <option value="points">Points</option>
                    <option value="goals">Goals</option>
                    <option value="assists">Assists</option>
                    <option value="shots">Shots</option>
                    <option value="saves" id="savesOption" style="display:none;">Saves</option>
                    <option value="savePct" id="savePctOption" style="display:none;">Save %</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="minGames">Min Games:</label>
                <select id="minGames" onchange="loadData()">
                    <option value="0">0</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="20">20</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="sortBy">Sort By:</label>
                <select id="sortBy" onchange="loadData()">
                    <option value="trend">Trend</option>
                    <option value="hitRate">Hit Rate</option>
                    <option value="last5">Last 5</option>
                    <option value="stat">Season Stat</option>
                    <option value="name">Name</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="hideZeros" onchange="loadData()">
                    Hide Zero Games
                </label>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="favoritesOnly" onchange="loadData()">
                    Favorites Only
                </label>
            </div>
            
            <div class="control-group">
                <input type="text" id="searchName" placeholder="Search player..." onkeyup="loadData()">
            </div>
        </div>
        
        <div id="playersContainer" class="loading">Loading player data...</div>
    </div>
    
    <!-- Game Log Modal -->
    <div id="gameLogModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <script>
        // Global state
        let currentStatType = 'points';
        let isGoalieMode = false;
        let cachedData = null;
        let teamShotData = [];
        
        // Load preferences from localStorage
        function loadPreferences() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true') {
                document.body.classList.add('dark-mode');
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        
        // Toggle between skaters and goalies
        function toggleGoalies() {
            isGoalieMode = document.getElementById('showGoalies').checked;
            
            // Show/hide goalie-specific stat options
            const savesOption = document.getElementById('savesOption');
            const savePctOption = document.getElementById('savePctOption');
            const statSelect = document.getElementById('statType');
            
            if (isGoalieMode) {
                savesOption.style.display = '';
                savePctOption.style.display = '';
                statSelect.value = 'saves';
                currentStatType = 'saves';
            } else {
                savesOption.style.display = 'none';
                savePctOption.style.display = 'none';
                statSelect.value = 'points';
                currentStatType = 'points';
            }
            
            loadData();
        }
        
        // Update stat type
        function updateStatType() {
            currentStatType = document.getElementById('statType').value;
            loadData();
        }
        
        // Get favorites from localStorage
        function getFavorites() {
            const saved = localStorage.getItem('nhlFavorites');
            return saved ? JSON.parse(saved) : [];
        }
        
        // Save favorites
        function saveFavorites(favorites) {
            localStorage.setItem('nhlFavorites', JSON.stringify(favorites));
        }
        
        // Toggle favorite
        function toggleFavorite(playerId, event) {
            event.stopPropagation();
            let favorites = getFavorites();
            if (favorites.includes(playerId)) {
                favorites = favorites.filter(id => id !== playerId);
            } else {
                favorites.push(playerId);
            }
            saveFavorites(favorites);
            loadData();
        }
        
        // Load data from backend
        async function loadData() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const minGames = document.getElementById('minGames').value;
                const searchName = document.getElementById('searchName').value;
                const hideZeros = document.getElementById('hideZeros').checked;
                const favoritesOnly = document.getElementById('favoritesOnly').checked;
                const sortBy = document.getElementById('sortBy').value;
                const favorites = getFavorites();
                
                let endpoint, params;
                
                if (isGoalieMode) {
                    endpoint = '/api/goalies';
                    params = new URLSearchParams({
                        stat: currentStatType,
                        minGames,
                        searchName,
                        sortBy,
                        favorites: favorites.join(',')
                    });
                } else {
                    endpoint = '/api/players';
                    params = new URLSearchParams({
                        stat: currentStatType,
                        minGames,
                        searchName,
                        hideZeros: hideZeros.toString(),
                        sortBy,
                        favorites: favorites.join(',')
                    });
                }
                
                const response = await fetch(`${endpoint}?${params}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Get cached data for team shot info
                const cacheResponse = await fetch('/api/get-data');
                cachedData = await cacheResponse.json();
                teamShotData = cachedData.teamShotData || [];
                
                // Filter favorites if needed
                let playersToDisplay = isGoalieMode ? data.goalies : data.players;
                if (favoritesOnly) {
                    playersToDisplay = playersToDisplay.filter(p => favorites.includes(p.playerId));
                }
                
                displayPlayers(playersToDisplay, data.meta);
                
            } catch (error) {
                container.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }
        
        // Display players/goalies
        function displayPlayers(players, meta) {
            const container = document.getElementById('playersContainer');
            const favorites = getFavorites();
            
            if (players.length === 0) {
                container.innerHTML = '<div class="loading">No players found matching your criteria</div>';
                return;
            }
            
            const cardsHtml = players.map(player => {
                const isFavorited = favorites.includes(player.playerId);
                const starIcon = isFavorited ? '⭐' : '☆';
                
                // Get trend indicator
                const trendClass = player.trend > 10 ? 'trend-up' : player.trend < -10 ? 'trend-down' : 'trend-neutral';
                const trendIcon = player.trend > 0 ? '📈' : player.trend < 0 ? '📉' : '➡️';
                
                // Get betting line if available
                let bettingLineHtml = '';
                if (player.bettingLine) {
                    bettingLineHtml = `
                        <div class="betting-line">
                            🎯 Line: ${player.bettingLine.line} (${player.bettingLine.over > 0 ? '+' : ''}${player.bettingLine.over}/${player.bettingLine.under > 0 ? '+' : ''}${player.bettingLine.under})
                        </div>
                    `;
                }
                
                // Get next opponent analysis
                let opponentHtml = '';
                if (player.nextOpponent && teamShotData.length > 0) {
                    const oppTeam = findOpponentTeam(player.nextOpponent);
                    if (oppTeam) {
                        const rankBadge = getRankBadge(oppTeam.defensiveRank, isGoalieMode);
                        opponentHtml = `
                            <div class="opponent-analysis">
                                <strong>🎯 vs ${oppTeam.teamFullName.split(' ').pop()}</strong>
                                ${rankBadge}
                                <br>
                                ${isGoalieMode ? 
                                    `Allow ${oppTeam.shotsPerGame.toFixed(1)} shots/game` :
                                    `Allow ${oppTeam.shotsAgainstPerGame.toFixed(1)} shots/game`
                                }
                            </div>
                        `;
                    }
                }
                
                // Get season stat value
                const statValue = isGoalieMode ? 
                    (currentStatType === 'savePct' ? 
                        (player.seasonStats.savePct * 100).toFixed(1) + '%' :
                        player.seasonStats[currentStatType]) :
                    player.seasonStats[currentStatType];
                
                // Recent games display
                let recentGamesHtml = '';
                if (player.recentGames && player.recentGames.length > 0) {
                    const gamesDisplay = player.recentGames.slice(0, 3).map(game => {
                        if (isGoalieMode) {
                            return `
                                <div class="game-result">
                                    <span>vs ${game.opponent}</span>
                                    <span>${game.saves} SV (${(game.savePct * 100).toFixed(1)}%)</span>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="game-result">
                                    <span>vs ${game.opponent}</span>
                                    <span>${game.goals}G ${game.assists}A ${game.shots}S</span>
                                </div>
                            `;
                        }
                    }).join('');
                    
                    recentGamesHtml = `
                        <div class="recent-games">
                            <div class="recent-games-header">Last 3 Games:</div>
                            ${gamesDisplay}
                        </div>
                    `;
                }
                
                return `
                    <div class="player-card" onclick="openGameLog(${player.playerId})">
                        <div class="player-header">
                            <div class="player-info">
                                <h3>${player.name}</h3>
                                <div class="player-meta">
                                    ${player.team} • ${player.position} • ${player.gamesPlayed} GP
                                </div>
                            </div>
                            <div class="favorite-star" onclick="toggleFavorite(${player.playerId}, event)">
                                ${starIcon}
                            </div>
                        </div>
                        
                        <div class="stat-highlight">
                            ${currentStatType.toUpperCase()}: ${statValue}
                        </div>
                        
                        ${bettingLineHtml}
                        
                        <div class="hit-rate-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <strong>Hit Rate: ${player.hitRate}%</strong>
                                <span class="trend-indicator ${trendClass}">
                                    ${trendIcon} ${player.trend > 0 ? '+' : ''}${player.trend}%
                                </span>
                            </div>
                            <div class="hit-rate-bar-container">
                                <div class="hit-rate-bar" style="width: ${player.hitRate}%">
                                    ${player.hitRate > 20 ? player.hitRate + '%' : ''}
                                </div>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                                L5: ${player.last5Rate}% | L10: ${player.last10Rate}%
                            </div>
                        </div>
                        
                        ${opponentHtml}
                        ${recentGamesHtml}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = cardsHtml;
            
            // Update status message
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status';
            statusDiv.textContent = `Showing ${players.length} ${isGoalieMode ? 'goalies' : 'players'} • Last updated: ${new Date(meta.lastUpdated).toLocaleString()}`;
        }
        
        // Find opponent team in shot data
        function findOpponentTeam(opponentName) {
            return teamShotData.find(t => 
                t.teamFullName === opponentName ||
                t.abbrev === opponentName ||
                t.teamFullName.includes(opponentName) ||
                opponentName.includes(t.teamFullName)
            );
        }
        
        // Get rank badge based on position
        function getRankBadge(rank, isGoalie) {
            let badgeClass, label;
            
            if (isGoalie) {
                // For goalies: high rank (lots of shots) is harder
                if (rank <= 10) {
                    badgeClass = 'rank-hard';
                    label = `#${rank}`;
                } else if (rank <= 22) {
                    badgeClass = 'rank-medium';
                    label = `#${rank}`;
                } else {
                    badgeClass = 'rank-easy';
                    label = `#${rank}`;
                }
            } else {
                // For skaters: low rank (allows lots of shots) is easier
                if (rank <= 10) {
                    badgeClass = 'rank-easy';
                    label = `#${rank}`;
                } else if (rank <= 22) {
                    badgeClass = 'rank-medium';
                    label = `#${rank}`;
                } else {
                    badgeClass = 'rank-hard';
                    label = `#${rank}`;
                }
            }
            
            return `<span class="rank-badge ${badgeClass}">${label}</span>`;
        }
        
        // Open game log modal
        async function openGameLog(playerId) {
            const modal = document.getElementById('gameLogModal');
            const modalBody = document.getElementById('modalBody');
            
            modal.style.display = 'block';
            modalBody.innerHTML = '<div class="loading">Loading game log...</div>';
            
            try {
                // Get player details with game log
                const type = isGoalieMode ? 'goalie' : 'skater';
                const response = await fetch(`/api/player-details?playerId=${playerId}&type=${type}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load player details: ${response.status}`);
                }
                
                const data = await response.json();
                displayGameLog(data);
                
            } catch (error) {
                modalBody.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }
        
        // Display game log in modal
        function displayGameLog(data) {
            const modalBody = document.getElementById('modalBody');
            const player = data.player;
            const games = data.games || [];
            const h2hStats = data.h2hStats;
            const opponentInfo = data.opponentInfo;
            
            // H2H section
            let h2hHtml = '';
            if (h2hStats && h2hStats.gamesPlayed > 0) {
                const stats = h2hStats.stats;
                h2hHtml = `
                    <div style="background: var(--success-bg); color: var(--success-text); padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h3>📊 Head-to-Head Stats</h3>
                        <p><strong>Games Played:</strong> ${h2hStats.gamesPlayed}</p>
                        ${stats.avgGoals ? `<p><strong>Avg Goals:</strong> ${stats.avgGoals}</p>` : ''}
                        ${stats.avgAssists ? `<p><strong>Avg Assists:</strong> ${stats.avgAssists}</p>` : ''}
                        ${stats.avgPoints ? `<p><strong>Avg Points:</strong> ${stats.avgPoints}</p>` : ''}
                        ${stats.avgSaves ? `<p><strong>Avg Saves:</strong> ${stats.avgSaves}</p>` : ''}
                        ${stats.avgSavePct ? `<p><strong>Avg Save %:</strong> ${stats.avgSavePct}%</p>` : ''}
                        ${h2hStats.hitRate ? `<p><strong>Hit Rate:</strong> ${h2hStats.hitRate}%</p>` : ''}
                    </div>
                `;
            }
            
            // Opponent info section
            let opponentHtml = '';
            if (opponentInfo) {
                opponentHtml = `
                    <div style="background: var(--warning-bg); color: var(--warning-text); padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h3>🎯 Opponent Analysis</h3>
                        <p><strong>Team:</strong> ${opponentInfo.teamName}</p>
                        <p><strong>Shots For/Game:</strong> ${opponentInfo.shotsPerGame} (Rank #${opponentInfo.offensiveRank})</p>
                        <p><strong>Shots Against/Game:</strong> ${opponentInfo.shotsAgainstPerGame} (Rank #${opponentInfo.defensiveRank})</p>
                    </div>
                `;
            }
            
            const isGoalie = player.position === 'G';
            
            // Season stats
            let seasonStatsHtml = '';
            if (isGoalie) {
                seasonStatsHtml = `
                    <p><strong>Record:</strong> ${data.seasonStats.wins}-${data.seasonStats.losses}-${data.seasonStats.otLosses}</p>
                    <p><strong>Save %:</strong> ${(data.seasonStats.savePct * 100).toFixed(1)}%</p>
                    <p><strong>GAA:</strong> ${data.seasonStats.goalsAgainstAverage.toFixed(2)}</p>
                    <p><strong>Shutouts:</strong> ${data.seasonStats.shutouts}</p>
                `;
            } else {
                seasonStatsHtml = `
                    <p><strong>Goals:</strong> ${data.seasonStats.goals}</p>
                    <p><strong>Assists:</strong> ${data.seasonStats.assists}</p>
                    <p><strong>Points:</strong> ${data.seasonStats.points}</p>
                    <p><strong>Shots:</strong> ${data.seasonStats.shots}</p>
                    <p><strong>PPG:</strong> ${data.seasonStats.pointsPerGame.toFixed(2)}</p>
                `;
            }
            
            // Badge legend
            let badgeLegend = '';
            if (isGoalie) {
                badgeLegend = `
                    <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.85em; color: var(--text-secondary);">
                        <strong>Badge Colors:</strong> 
                        <span class="rank-badge rank-hard">#1-10</span> High shot volume (more work) 
                        <span class="rank-badge rank-medium">#11-22</span> Medium 
                        <span class="rank-badge rank-easy">#23-32</span> Low shot volume (easier)
                    </div>
                `;
            } else if (currentStatType === 'shots') {
                badgeLegend = `
                    <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.85em; color: var(--text-secondary);">
                        <strong>Badge Colors:</strong> 
                        <span class="rank-badge rank-easy">#1-10</span> Allow most shots (easier) 
                        <span class="rank-badge rank-medium">#11-22</span> Medium 
                        <span class="rank-badge rank-hard">#23-32</span> Allow fewest shots (harder)
                    </div>
                `;
            }
            
            // Game rows
            const gameRows = games.slice(0, 20).map(game => {
                const date = new Date(game.gameDate).toLocaleDateString();
                
                // Find opponent in team data for badge
                const oppTeam = findOpponentTeam(game.opponent);
                let oppBadge = '';
                if (oppTeam) {
                    oppBadge = getRankBadge(oppTeam.defensiveRank, isGoalie);
                }
                
                if (isGoalie) {
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${game.opponent} ${oppBadge}</td>
                            <td>${game.decision || '-'}</td>
                            <td>${game.saves}</td>
                            <td>${game.shotsAgainst}</td>
                            <td>${game.goalsAgainst}</td>
                            <td>${(game.savePct * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td>${date}</td>
                            <td>${game.opponent} ${oppBadge}</td>
                            <td>${game.goals}</td>
                            <td>${game.assists}</td>
                            <td>${game.points}</td>
                            <td>${game.shots}</td>
                        </tr>
                    `;
                }
            }).join('');
            
            modalBody.innerHTML = `
                <h2>${player.name}</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    ${player.team} • ${player.position} • ${player.gamesPlayed} GP
                </p>
                
                <h3>Season Stats</h3>
                <div style="margin-bottom: 20px;">
                    ${seasonStatsHtml}
                </div>
                
                ${h2hHtml}
                ${opponentHtml}
                
                <h3>Last ${Math.min(20, games.length)} Games</h3>
                ${badgeLegend}
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            ${isGoalie ? `
                                <th>Decision</th>
                                <th>Saves</th>
                                <th>SA</th>
                                <th>GA</th>
                                <th>SV%</th>
                            ` : `
                                <th>G</th>
                                <th>A</th>
                                <th>P</th>
                                <th>S</th>
                            `}
                        </tr>
                    </thead>
                    <tbody>
                        ${gameRows}
                    </tbody>
                </table>
            `;
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('gameLogModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('gameLogModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPreferences();
            loadData();
        });
    </script>
</body>
</html>
