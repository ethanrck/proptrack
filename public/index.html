<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5273674349795842"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DangleData - NHL Player Line Tracker</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="config.js"></script>
    <script src="api-client.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-gradient-start: #1e3c72;
            --bg-gradient-end: #2a5298;
            --container-bg: white;
            --text-primary: #1e3c72;
            --text-secondary: #666;
            --card-bg: #f8f9fa;
            --card-hover-border: #2a5298;
            --button-bg: white;
            --button-text: #2a5298;
            --button-active-bg: #2a5298;
            --button-active-text: white;
            --modal-overlay: rgba(0,0,0,0.7);
            --table-header-bg: #2a5298;
            --table-border: #ddd;
            --input-border: #ddd;
            --warning-bg: #fff3cd;
            --warning-text: #856404;
            --success-bg: #d4edda;
            --success-text: #155724;
            --error-bg: #f8d7da;
            --error-text: #721c24;
            --hit-bg: #d4edda;
            --miss-bg: #f8d7da;
        }
        
        body.dark-mode {
            --bg-gradient-start: #0a1929;
            --bg-gradient-end: #1a2332;
            --container-bg: #1e2936;
            --text-primary: #e3f2fd;
            --text-secondary: #b0bec5;
            --card-bg: #263238;
            --card-hover-border: #4fc3f7;
            --button-bg: #263238;
            --button-text: #4fc3f7;
            --button-active-bg: #4fc3f7;
            --button-active-text: #0a1929;
            --modal-overlay: rgba(0,0,0,0.85);
            --table-header-bg: #1565c0;
            --table-border: #37474f;
            --input-border: #37474f;
            --warning-bg: #3e2723;
            --warning-text: #ffb74d;
            --success-bg: #1b5e20;
            --success-text: #81c784;
            --error-bg: #b71c1c;
            --error-text: #ef5350;
            --hit-bg: #2e7d32;
            --miss-bg: #c62828;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }
        
        h1 {
            color: var(--text-primary);
            font-size: 2.5em;
            transition: color 0.3s ease;
            text-align: center;
        }
        
        .dark-mode-toggle {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            position: absolute;
            right: 0;
        }
        
        .dark-mode-toggle:hover {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }
        
        .api-status {
            background: var(--warning-bg);
            color: var(--warning-text);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        label {
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        input[type="text"], input[type="checkbox"], select {
            padding: 10px;
            font-size: 16px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            background: var(--container-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        select {
            cursor: pointer;
        }
        
        select option {
            background: var(--container-bg);
            color: var(--text-primary);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .stat-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stat-button {
            padding: 12px 24px;
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-text);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stat-button:hover {
            opacity: 0.8;
        }
        
        .stat-button.active {
            background: var(--button-active-bg);
            color: var(--button-active-text);
        }
        
        .search-box {
            flex-grow: 1;
            min-width: 250px;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .player-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-color: var(--card-hover-border);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }
        
        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-primary);
            flex: 1;
            transition: color 0.3s ease;
            min-height: 2.4em;
            display: flex;
            align-items: center;
            line-height: 1.2;
        }
        
        .odds-line {
            font-size: 0.9em;
            font-weight: 600;
            color: #e67e22;
            background: var(--warning-bg);
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .odds-line:hover {
            background: #e67e22;
            color: white;
            transform: scale(1.05);
        }
        
        .player-team {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        
        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .hit-rate-display {
            margin-top: 10px;
            padding: 10px;
            background: var(--container-bg);
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .hit-rate-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .hit-rate-excellent {
            color: #27ae60;
        }
        
        .hit-rate-good {
            color: #2ecc71;
        }
        
        .hit-rate-medium {
            color: #f39c12;
        }
        
        .hit-rate-poor {
            color: #e74c3c;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 18px;
            transition: color 0.3s ease;
        }
        
        .error {
            background: var(--error-bg);
            color: var(--error-text);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .game-log-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .modal-content {
            background: var(--container-bg);
            max-width: 1000px;
            margin: 20px auto;
            border-radius: 15px;
            padding: 30px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .close-modal:hover {
            color: var(--text-primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th {
            background: var(--table-header-bg);
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--table-border);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        tr:hover {
            background: var(--card-bg);
        }
        
        .hit {
            background-color: var(--hit-bg) !important;
        }
        
        .miss {
            background-color: var(--miss-bg) !important;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .summary-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        
        .summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .h2h-section {
            background: var(--warning-bg);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .h2h-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--warning-text);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .h2h-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .h2h-stat {
            text-align: center;
            padding: 10px;
            background: var(--container-bg);
            border-radius: 5px;
        }
        
        .h2h-stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }
        
        .h2h-stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        /* Watchlist Styles */
        .watchlist-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: var(--container-bg);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 999;
            transition: all 0.3s ease;
            border: 2px solid var(--card-hover-border);
        }
        
        .watchlist-container.minimized {
            max-height: 60px;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .watchlist-container {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
        }
        
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--button-active-bg);
            color: var(--button-active-text);
            border-radius: 13px 13px 0 0;
            cursor: pointer;
            user-select: none;
        }
        
        .watchlist-title {
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .parlay-badge {
            background: #FFD700;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .watchlist-toggle {
            font-size: 1.3em;
            transition: transform 0.3s;
        }
        
        .watchlist-container.minimized .watchlist-toggle {
            transform: rotate(180deg);
        }
        
        .watchlist-content {
            padding: 15px;
            max-height: 380px;
            overflow-y: auto;
        }
        
        .watchlist-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .watchlist-item {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .watchlist-item:hover {
            border-color: var(--card-hover-border);
        }
        
        .watchlist-item.selected {
            background: var(--button-active-bg);
            border-color: var(--button-active-bg);
        }
        
        .watchlist-item.selected .watchlist-item-name,
        .watchlist-item.selected .watchlist-item-line {
            color: var(--button-active-text);
        }
        
        .watchlist-item-info {
            flex: 1;
        }
        
        .watchlist-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }
        
        .watchlist-item-line {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .watchlist-item-odds {
            font-weight: bold;
            color: #e67e22;
            margin-right: 10px;
        }
        
        .watchlist-item-remove {
            background: var(--error-bg);
            color: var(--error-text);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .watchlist-item-remove:hover {
            opacity: 0.8;
        }
        
        .parlay-calculator {
            background: var(--warning-bg);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .parlay-title {
            font-weight: bold;
            color: var(--warning-text);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .parlay-odds {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .parlay-payout {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .parlay-legs {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        h2, h3 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        p {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        /* Collapsible Available Lines Section */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            transition: all 0.3s ease;
        }
        
        .collapsible-header:hover {
            opacity: 0.8;
        }
        
        .toggle-arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            display: inline-block;
            margin-left: 10px;
        }
        
        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.expanded {
            max-height: 2000px; /* Large enough to fit content */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1>🎯 DangleData</h1>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">🌙 Dark Mode</button>
        </div>
        <p class="subtitle">NHL Player Line Tracker - 2025-2026 Season</p>
        
        <div class="api-status" id="apiStatus">
            📊 Loading cached data...
        </div>
        
        <div class="controls">
            <div class="control-group search-box">
                <label>Search Player:</label>
                <input type="text" id="searchPlayer" placeholder="Type player name..." oninput="filterPlayers()" style="flex-grow: 1;">
            </div>
            
            <div class="control-group">
                <label>Filter by Game:</label>
                <select id="gameFilter" onchange="filterPlayers()" style="padding: 10px; font-size: 16px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--container-bg); color: var(--text-primary); min-width: 250px;">
                    <option value="">All Games</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Filter by Line:</label>
                <select id="lineFilter" onchange="filterPlayers()" style="padding: 10px; font-size: 16px; border: 2px solid var(--input-border); border-radius: 8px; background: var(--container-bg); color: var(--text-primary); min-width: 150px;">
                    <option value="">All Lines</option>
                </select>
            </div>
            
            <div class="control-group">
                <input type="checkbox" id="hideNoLines" onchange="filterPlayers()" checked>
                <label for="hideNoLines">Hide players without betting lines</label>
            </div>
            
            <div class="control-group">
                <input type="checkbox" id="hideStartedGames" onchange="filterPlayers()">
                <label for="hideStartedGames">Hide games that have started</label>
            </div>
        </div>
        
        <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; transition: all 0.3s ease;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-primary);">Select Stat:</label>
            <div class="stat-buttons">
                <button class="stat-button active" onclick="selectStat('points')">Points</button>
                <button class="stat-button" onclick="selectStat('goals')">Goals</button>
                <button class="stat-button" onclick="selectStat('assists')">Assists</button>
                <button class="stat-button" onclick="selectStat('shots')">Shots</button>
                <button class="stat-button" onclick="selectStat('saves')">Goalie Saves</button>
                <button class="stat-button" onclick="selectStat('team_totals')">Team Totals</button>
            </div>
        </div>
        
        <div id="playersContainer" class="players-grid">
            <div class="loading">Loading all players from cache...</div>
        </div>
        
        <div id="ad-bottom-banner" style="text-align: center; margin: 30px 0 20px 0; padding: 15px; background: var(--card-bg); border-radius: 8px; min-height: 90px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); border: 2px dashed var(--input-border);">
            <div>📢 Ad Space - 728x90 Banner</div>
        </div>
        
        <div id="ad-sidebar" style="position: fixed; right: 20px; top: 100px; width: 160px; background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; color: var(--text-secondary); border: 2px dashed var(--input-border); display: none;">
            <div style="font-size: 12px;">📢 Ad Space<br>160x600<br>Skyscraper</div>
        </div>
        
        <!-- Watchlist -->
        <div id="watchlistContainer" class="watchlist-container">
            <div class="watchlist-header" onclick="toggleWatchlist()">
                <div class="watchlist-title">
                    ⭐ Watchlist <span id="watchlistCount">(0)</span>
                </div>
                <div class="watchlist-toggle">▼</div>
            </div>
            <div class="watchlist-content">
                <div id="watchlistItems"></div>
                <div id="parlayCalculator"></div>
            </div>
        </div>
        
        <style>
            @media (min-width: 1600px) {
                #ad-sidebar {
                    display: block !important;
                }
            }
        </style>
    </div>
    
    <div id="gameLogModal" class="game-log-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // API_BASE_URL is now defined in config.js
        
        let allPlayersData = [];
        let allGoaliesData = [];
        let allGameLogs = {};
        let allGoalieGameLogs = {};
        let teamShotData = [];
        let filteredPlayers = [];
        let playerHitRates = {};
        let bettingOdds = {};
        let currentStatType = 'points';
        let isGoalieMode = false;
        let isTeamTotalsMode = false;
        let watchlist = [];
        let selectedParlayPlayers = [];

        // Helper function to normalize betting odds (handles both old object and new array format)
        function getLinesArray(playerOdds, statType) {
            if (!playerOdds || !playerOdds[statType]) {
                return [];
            }
            // If it's already an array, return it
            if (Array.isArray(playerOdds[statType])) {
                return playerOdds[statType];
            }
            // If it's an old-format object, wrap it in an array for compatibility
            return [playerOdds[statType]];
        }

        // Load watchlist from localStorage on page load
        function loadWatchlist() {
            const saved = localStorage.getItem('nhlWatchlist');
            if (saved) {
                try {
                    watchlist = JSON.parse(saved);
                    updateWatchlistDisplay();
                } catch (e) {
                    console.error('Error loading watchlist:', e);
                    watchlist = [];
                }
            }
            
            // Load minimized state
            const isMinimized = localStorage.getItem('watchlistMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('watchlistContainer').classList.add('minimized');
            }
        }

        // Save watchlist to localStorage
        function saveWatchlist() {
            localStorage.setItem('nhlWatchlist', JSON.stringify(watchlist));
            updateWatchlistDisplay();
        }

        // Toggle watchlist minimize/maximize
        function toggleWatchlist() {
            const container = document.getElementById('watchlistContainer');
            container.classList.toggle('minimized');
            
            // Save state
            const isMinimized = container.classList.contains('minimized');
            localStorage.setItem('watchlistMinimized', isMinimized);
        }

        // Add player to watchlist
        function addToWatchlist(playerId, playerName, statType, line, odds, game, gameTime, overUnder) {
            // Check if already in watchlist
            const exists = watchlist.find(item => 
                item.playerId === playerId && item.statType === statType
            );
            
            if (exists) {
                // Remove from watchlist
                watchlist = watchlist.filter(item => 
                    !(item.playerId === playerId && item.statType === statType)
                );
            } else {
                // Add to watchlist
                watchlist.push({
                    playerId,
                    playerName,
                    statType,
                    line,
                    odds,
                    game,
                    gameTime,
                    overUnder: overUnder || null, // 'over', 'under', or null
                    addedAt: new Date().toISOString()
                });
            }
            
            saveWatchlist();
            return !exists; // Return true if added, false if removed
        }

        // Check if player is in watchlist
        function isInWatchlist(playerId, statType) {
            return watchlist.some(item => 
                item.playerId === playerId && item.statType === statType
            );
        }

        // Toggle player selection for parlay
        function toggleParlaySelection(playerId, statType) {
            const key = `${playerId}-${statType}`;
            const index = selectedParlayPlayers.indexOf(key);
            
            if (index > -1) {
                selectedParlayPlayers.splice(index, 1);
            } else {
                selectedParlayPlayers.push(key);
            }
            
            updateWatchlistDisplay();
        }

        // Calculate parlay odds from American odds
        function calculateParlayOdds(americanOddsArray) {
            if (americanOddsArray.length === 0) return null;
            if (americanOddsArray.length === 1) return americanOddsArray[0];
            
            // Convert American odds to decimal
            const decimalOdds = americanOddsArray.map(odds => {
                if (odds > 0) {
                    return (odds / 100) + 1;
                } else {
                    return (100 / Math.abs(odds)) + 1;
                }
            });
            
            // Multiply all decimal odds
            const totalDecimal = decimalOdds.reduce((acc, odds) => acc * odds, 1);
            
            // Convert back to American odds
            if (totalDecimal >= 2) {
                return Math.round((totalDecimal - 1) * 100);
            } else {
                return Math.round(-100 / (totalDecimal - 1));
            }
        }

        // Calculate parlay payout
        function calculatePayout(americanOdds, bet = 100) {
            if (americanOdds > 0) {
                return bet + (bet * americanOdds / 100);
            } else {
                return bet + (bet * 100 / Math.abs(americanOdds));
            }
        }

        // Update watchlist display
        function updateWatchlistDisplay() {
            const container = document.getElementById('watchlistItems');
            const parlayContainer = document.getElementById('parlayCalculator');
            const countSpan = document.getElementById('watchlistCount');
            
            // Update count - show parlay badge if applicable
            if (selectedParlayPlayers.length >= 2) {
                countSpan.innerHTML = `(${watchlist.length}) <span class="parlay-badge">${selectedParlayPlayers.length} in parlay</span>`;
            } else {
                countSpan.textContent = `(${watchlist.length})`;
            }
            
            if (watchlist.length === 0) {
                container.innerHTML = '<div class="watchlist-empty">⭐ Click on betting lines to add players to your watchlist</div>';
                parlayContainer.innerHTML = '';
                return;
            }
            
            // Add header with clear button
            let headerHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="font-size: 0.9em; color: var(--text-secondary);">
                        Click to select for parlay
                    </div>
                    <button onclick="clearWatchlist()" 
                            style="background: var(--error-bg); color: var(--error-text); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                        Clear All
                    </button>
                </div>
            `;
            
            // Sort by most recently added
            const sortedWatchlist = [...watchlist].sort((a, b) => 
                new Date(b.addedAt) - new Date(a.addedAt)
            );
            
            const itemsHtml = sortedWatchlist.map(item => {
                const key = `${item.playerId}-${item.statType}`;
                const isSelected = selectedParlayPlayers.includes(key);
                const formattedOdds = item.odds > 0 ? `+${item.odds}` : item.odds;
                
                // Format line display with Over/Under prefix if specified
                let lineDisplay;
                if (item.statType === 'goals') {
                    lineDisplay = 'Anytime Goal';
                } else if (item.overUnder === 'over') {
                    lineDisplay = `O ${formattedOdds} (${item.line} ${item.statType})`;
                } else if (item.overUnder === 'under') {
                    lineDisplay = `U ${formattedOdds} (${item.line} ${item.statType})`;
                } else {
                    lineDisplay = `O/U ${item.line} ${item.statType}`;
                }
                
                return `
                    <div class="watchlist-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleParlaySelection(${item.playerId}, '${item.statType}')">
                        <div class="watchlist-item-info">
                            <div class="watchlist-item-name">${item.playerName}</div>
                            <div class="watchlist-item-line">
                                ${lineDisplay}
                            </div>
                        </div>
                        <div class="watchlist-item-odds">${item.overUnder ? '' : formattedOdds}</div>
                        <button class="watchlist-item-remove" 
                                onclick="event.stopPropagation(); removeFromWatchlist(${item.playerId}, '${item.statType}')">
                            ✕
                        </button>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = headerHtml + itemsHtml;
            
            // Show parlay calculator if 2+ players selected
            if (selectedParlayPlayers.length >= 2) {
                const selectedItems = watchlist.filter(item => 
                    selectedParlayPlayers.includes(`${item.playerId}-${item.statType}`)
                );
                const oddsArray = selectedItems.map(item => item.odds);
                const parlayOdds = calculateParlayOdds(oddsArray);
                const payout = calculatePayout(parlayOdds, 100);
                const profit = payout - 100;
                const formattedParlayOdds = parlayOdds > 0 ? `+${parlayOdds}` : parlayOdds;
                
                parlayContainer.innerHTML = `
                    <div class="parlay-calculator">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div class="parlay-title" style="margin: 0;">🎯 Parlay Calculator</div>
                            <button onclick="clearParlaySelection()" 
                                    style="background: none; border: none; color: var(--warning-text); cursor: pointer; font-size: 0.9em; text-decoration: underline;">
                                Clear
                            </button>
                        </div>
                        <div class="parlay-odds">${formattedParlayOdds}</div>
                        <div class="parlay-payout">
                            $100 bet wins <strong>$${profit.toFixed(2)}</strong> 
                            (total payout: $${payout.toFixed(2)})
                        </div>
                        <div class="parlay-legs">${selectedParlayPlayers.length}-leg parlay</div>
                    </div>
                `;
            } else {
                parlayContainer.innerHTML = selectedParlayPlayers.length === 1 ? 
                    '<div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 0.9em;">Select 2+ players to build a parlay</div>' : '';
            }
        }

        // Remove from watchlist
        function removeFromWatchlist(playerId, statType) {
            watchlist = watchlist.filter(item => 
                !(item.playerId === playerId && item.statType === statType)
            );
            
            // Also remove from parlay selection
            const key = `${playerId}-${statType}`;
            selectedParlayPlayers = selectedParlayPlayers.filter(k => k !== key);
            
            saveWatchlist();
        }

        // Toggle watchlist from modal (refreshes modal to update star)
        function toggleWatchlistFromModal(playerId, playerName, statType, line, odds, game, gameTime) {
            const wasAdded = addToWatchlist(playerId, playerName, statType, line, odds, game, gameTime);
            
            // Refresh the modal to update the star icon
            showGameLog(playerId);
            
            // Ensure modal stays open
            document.getElementById('gameLogModal').style.display = 'block';
        }

        // Clear entire watchlist
        function clearWatchlist() {
            if (confirm('Clear all players from watchlist?')) {
                watchlist = [];
                selectedParlayPlayers = [];
                saveWatchlist();
            }
        }

        // Clear parlay selection
        function clearParlaySelection() {
            selectedParlayPlayers = [];
            updateWatchlistDisplay();
        }

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            const btn = document.querySelector('.dark-mode-toggle');
            btn.textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
        }

        // Toggle Available Lines collapsible section
        function toggleAvailableLines(headerElement) {
            const content = headerElement.nextElementSibling;
            const arrow = headerElement.querySelector('.toggle-arrow');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                arrow.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                arrow.classList.add('expanded');
            }
        }

        // Load dark mode preference
        window.onload = function() {
            // Default to dark mode if no preference is saved
            const darkMode = localStorage.getItem('darkMode') !== 'false';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '☀️ Light Mode';
            }
            loadWatchlist();
            loadCachedData();
        };

        async function loadCachedData() {
            const container = document.getElementById('playersContainer');
            container.innerHTML = '<div class="loading">Loading all players from cache...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/get-data`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch cached data: ${response.status}`);
                }
                
                const data = await response.json();
                
                allPlayersData = data.allPlayers || [];
                allGoaliesData = data.allGoalies || [];
                allGameLogs = data.gameLogs || {};
                allGoalieGameLogs = data.goalieGameLogs || {};
                bettingOdds = data.bettingOdds || {};
                teamShotData = data.teamShotData || [];
                
                allPlayersData = allPlayersData.filter(p => (p.gamesPlayed || 0) > 0);
                allGoaliesData = allGoaliesData.filter(g => (g.gamesPlayed || 0) > 0);
                filteredPlayers = [...allPlayersData];
                
                const statusDiv = document.getElementById('apiStatus');
                const bettingLinesCount = data.stats?.bettingLinesLoaded || 0;
                const goalieCount = allGoaliesData.length;
                const teamCount = teamShotData.length;
                statusDiv.innerHTML = `✅ Loaded ${allPlayersData.length} players | ${goalieCount} goalies | ${teamCount} teams | ${data.stats.gameLogsLoaded} game logs | ${bettingLinesCount} betting lines | Last updated: ${new Date(data.lastUpdated).toLocaleString()}`;
                statusDiv.style.background = 'var(--success-bg)';
                statusDiv.style.color = 'var(--success-text)';
                
                filterPlayers();
                populateGameFilter();
                populateLineFilter();

            } catch (error) {
                container.innerHTML = `<div class="error"><strong>Error loading cached data:</strong> ${error.message}</div>`;
                console.error('Error:', error);
            }
        }

        function populateGameFilter() {
            const gameFilter = document.getElementById('gameFilter');
            const uniqueGames = new Set();
            
            // Iterate through betting odds and collect unique games
            Object.values(bettingOdds).forEach(playerOdds => {
                Object.values(playerOdds).forEach(statOdds => {
                    // statOdds is now an array of line objects
                    if (Array.isArray(statOdds)) {
                        statOdds.forEach(lineObj => {
                            if (lineObj.game) {
                                uniqueGames.add(lineObj.game);
                            }
                        });
                    }
                });
            });
            
            const gamesWithTime = Array.from(uniqueGames).map(game => {
                let gameTime = null;
                // Find the gameTime for this game
                for (const playerOdds of Object.values(bettingOdds)) {
                    for (const statOdds of Object.values(playerOdds)) {
                        if (Array.isArray(statOdds)) {
                            const lineObj = statOdds.find(l => l.game === game);
                            if (lineObj) {
                                gameTime = new Date(lineObj.gameTime);
                                break;
                            }
                        }
                    }
                    if (gameTime) break;
                }
                return { game, gameTime };
            }).sort((a, b) => a.gameTime - b.gameTime);
            
            gameFilter.innerHTML = '<option value="">All Games</option>';
            
            gamesWithTime.forEach(({ game, gameTime }) => {
                const option = document.createElement('option');
                option.value = game;
                const timeStr = gameTime.toLocaleString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                option.textContent = `${game} - ${timeStr}`;
                gameFilter.appendChild(option);
            });
            
            console.log(`Populated ${uniqueGames.size} games in filter`);
        }

        function populateLineFilter() {
            const lineFilter = document.getElementById('lineFilter');
            const uniqueLines = new Set();
            
            // Collect all unique betting line values for the current stat type
            // Lines are now stored as arrays, so we need to iterate through them
            Object.values(bettingOdds).forEach(playerOdds => {
                if (currentStatType === 'team_totals') {
                    // For team totals, include both main and alternate lines
                    if (playerOdds.team_totals && Array.isArray(playerOdds.team_totals)) {
                        playerOdds.team_totals.forEach(lineObj => {
                            uniqueLines.add(lineObj.line);
                        });
                    }
                    if (playerOdds.alternate_team_totals && Array.isArray(playerOdds.alternate_team_totals)) {
                        playerOdds.alternate_team_totals.forEach(lineObj => {
                            uniqueLines.add(lineObj.line);
                        });
                    }
                } else {
                    // For other stat types, use the current stat type
                    if (playerOdds[currentStatType] && Array.isArray(playerOdds[currentStatType])) {
                        playerOdds[currentStatType].forEach(lineObj => {
                            uniqueLines.add(lineObj.line);
                        });
                    }
                }
            });
            
            // Sort lines numerically
            const sortedLines = Array.from(uniqueLines).sort((a, b) => a - b);
            
            lineFilter.innerHTML = '<option value="">All Lines</option>';
            
            sortedLines.forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.textContent = line;
                lineFilter.appendChild(option);
            });
            
            console.log(`Populated ${uniqueLines.size} unique lines for ${currentStatType}`);
        }

        function selectStat(stat) {
            currentStatType = stat;
            isGoalieMode = (stat === 'saves');
            isTeamTotalsMode = (stat === 'team_totals');
            
            document.querySelectorAll('.stat-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const buttons = document.querySelectorAll('.stat-button');
            buttons.forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if ((stat === 'saves' && btnText.includes('goalie')) ||
                    (stat === 'points' && btnText === 'points') ||
                    (stat === 'goals' && btnText === 'goals') ||
                    (stat === 'assists' && btnText === 'assists') ||
                    (stat === 'shots' && btnText === 'shots') ||
                    (stat === 'team_totals' && btnText.includes('team'))) {
                    btn.classList.add('active');
                }
            });
            
            if (isTeamTotalsMode) {
                // For team totals, we don't use player data
                filteredPlayers = [];
            } else if (isGoalieMode) {
                filteredPlayers = [...allGoaliesData];
            } else {
                filteredPlayers = [...allPlayersData];
            }
            
            document.getElementById('gameFilter').value = '';
            document.getElementById('lineFilter').value = '';
            populateGameFilter();
            populateLineFilter();
            
            if (isTeamTotalsMode) {
                displayTeams();
            } else {
                filterPlayers();
            }
        }

        // Helper function to find the main/default line (not alternate)
        // Prioritizes non-alternate lines from the API, then major bookmakers
        function getMainLine(linesArray) {
            if (!linesArray || linesArray.length === 0) return null;
            if (linesArray.length === 1) return linesArray[0];
            
            // PRIORITY 1: Filter to non-alternate lines only if available
            const nonAlternateLines = linesArray.filter(lineObj => !lineObj.isAlternate);
            let linesToUse = nonAlternateLines.length > 0 ? nonAlternateLines : linesArray;
            
            // FALLBACK: Smart detection for shots - 0.5 is almost always an alternate
            // Main shot lines are typically 2.5-4.5
            if (linesToUse === linesArray && currentStatType === 'shots') {
                const reasonableLines = linesArray.filter(lineObj => lineObj.line >= 1.5);
                if (reasonableLines.length > 0) {
                    linesToUse = reasonableLines;
                }
            }
            
            // FALLBACK: For any stat, filter out extreme outliers if we have better options
            if (linesToUse === linesArray && linesArray.length > 2) {
                const lineValues = linesArray.map(l => l.line).sort((a, b) => a - b);
                const median = lineValues[Math.floor(lineValues.length / 2)];
                const iqr = lineValues[Math.floor(lineValues.length * 0.75)] - lineValues[Math.floor(lineValues.length * 0.25)];
                
                // Filter out lines more than 2x IQR away from median
                const filteredLines = linesArray.filter(lineObj => {
                    return Math.abs(lineObj.line - median) <= (iqr * 2 + 0.5);
                });
                
                if (filteredLines.length > 0) {
                    linesToUse = filteredLines;
                }
            }
            
            if (linesToUse.length === 1) return linesToUse[0];
            
            // PRIORITY 2: Major bookmakers that typically have the "main" line
            const majorBookmakers = ['DraftKings', 'FanDuel', 'BetMGM', 'Caesars', 'BetRivers'];
            
            for (const bookmaker of majorBookmakers) {
                const mainLine = linesToUse.find(lineObj => 
                    lineObj.bookmaker && lineObj.bookmaker.includes(bookmaker)
                );
                if (mainLine) return mainLine;
            }
            
            // PRIORITY 3: Use frequency + median approach
            const lineFrequency = {};
            const lineValues = [];
            
            linesToUse.forEach(lineObj => {
                const lineValue = lineObj.line;
                lineFrequency[lineValue] = (lineFrequency[lineValue] || 0) + 1;
                lineValues.push(lineValue);
            });
            
            // Find the maximum frequency
            let maxFrequency = 0;
            const candidateLines = [];
            
            for (const [lineValue, frequency] of Object.entries(lineFrequency)) {
                if (frequency > maxFrequency) {
                    maxFrequency = frequency;
                    candidateLines.length = 0;
                    candidateLines.push(parseFloat(lineValue));
                } else if (frequency === maxFrequency) {
                    candidateLines.push(parseFloat(lineValue));
                }
            }
            
            // If there's a tie, pick the one closest to median
            let mainLineValue;
            if (candidateLines.length > 1) {
                const sortedValues = [...lineValues].sort((a, b) => a - b);
                const median = sortedValues[Math.floor(sortedValues.length / 2)];
                
                mainLineValue = candidateLines.reduce((closest, current) => {
                    return Math.abs(current - median) < Math.abs(closest - median) ? current : closest;
                });
            } else {
                mainLineValue = candidateLines[0];
            }
            
            // Return the first line object with that value from our filtered list
            return linesToUse.find(lineObj => lineObj.line === mainLineValue);
        }

        function filterPlayers() {
            const searchTerm = document.getElementById('searchPlayer').value.toLowerCase();
            const hideNoLines = document.getElementById('hideNoLines').checked;
            const hideStartedGames = document.getElementById('hideStartedGames').checked;
            const selectedGame = document.getElementById('gameFilter').value;
            const selectedLine = document.getElementById('lineFilter').value;
            
            const sourceData = isGoalieMode ? allGoaliesData : allPlayersData;
            const currentTime = new Date();
            
            filteredPlayers = sourceData.filter(player => {
                const fullName = isGoalieMode ? 
                    `${player.goalieFullName || ''}`.toLowerCase() : 
                    `${player.skaterFullName || ''}`.toLowerCase();
                const matchesSearch = searchTerm === '' || fullName.includes(searchTerm);
                
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown Goalie') : 
                    (player.skaterFullName || 'Unknown Player');
                const playerOdds = bettingOdds[name];
                
                // Check if player has any lines for current stat
                const hasLine = playerOdds && Array.isArray(playerOdds[currentStatType]) && playerOdds[currentStatType].length > 0;
                const passesLineFilter = !hideNoLines || hasLine;
                
                // Check if player has any games that haven't started yet
                let hasUpcomingGame = true;
                if (hideStartedGames && hasLine) {
                    hasUpcomingGame = playerOdds[currentStatType].some(lineObj => {
                        if (lineObj.gameTime) {
                            const gameTime = new Date(lineObj.gameTime);
                            return gameTime > currentTime;
                        }
                        // If no gameTime, assume it hasn't started yet
                        return true;
                    });
                }
                
                // Check if ANY of the player's lines match the selected game
                let passesGameFilter = true;
                if (selectedGame && hasLine) {
                    passesGameFilter = playerOdds[currentStatType].some(lineObj => lineObj.game === selectedGame);
                }
                
                // Check if ANY of the player's lines match the selected line value
                let passesBettingLineFilter = true;
                if (selectedLine && hasLine) {
                    passesBettingLineFilter = playerOdds[currentStatType].some(lineObj => lineObj.line == parseFloat(selectedLine));
                }
                
                return matchesSearch && passesLineFilter && passesGameFilter && passesBettingLineFilter && hasUpcomingGame;
            });
            
            displayPlayers();
        }

        function getHitRateColor(hitRate) {
            if (hitRate >= 70) return 'hit-rate-excellent';
            if (hitRate >= 50) return 'hit-rate-good';
            if (hitRate >= 30) return 'hit-rate-medium';
            return 'hit-rate-poor';
        }
        
        function normalizeTeamName(name) {
            return name
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/St\./g, 'St') // Remove period from St.
                .replace(/\s+/g, ' ')   // Normalize whitespace
                .trim()
                .toLowerCase();
        }
        
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function displayPlayers() {
            const container = document.getElementById('playersContainer');
            const selectedLine = document.getElementById('lineFilter').value;
            
            const playersWithHitRates = filteredPlayers.map(player => {
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown Goalie') : 
                    (player.skaterFullName || 'Unknown Player');
                const playerOdds = bettingOdds[name];
                const hasLine = playerOdds && Array.isArray(playerOdds[currentStatType]) && playerOdds[currentStatType].length > 0;
                
                let lineValue = 0.5;
                if (hasLine) {
                    // If a line filter is selected, use that specific line; otherwise use the main/default line
                    if (selectedLine) {
                        const matchingLine = playerOdds[currentStatType].find(l => l.line == parseFloat(selectedLine));
                        lineValue = matchingLine ? matchingLine.line : getMainLine(playerOdds[currentStatType]).line;
                    } else {
                        lineValue = getMainLine(playerOdds[currentStatType]).line;
                    }
                }
                
                const gameLogSource = isGoalieMode ? allGoalieGameLogs : allGameLogs;
                const gameLog = gameLogSource[player.playerId];
                let hitRate = 0;
                let gamesPlayed = 0;
                
                if (gameLog && gameLog.gameLog && gameLog.gameLog.length > 0) {
                    let games = gameLog.gameLog;
                    if (isGoalieMode) {
                        games = games.filter(game => {
                            const shotsAgainst = game.shotsAgainst || 0;
                            const gamesStarted = game.gamesStarted || 0;
                            return gamesStarted > 0 || shotsAgainst > 0;
                        });
                    }
                    games = games.slice(0, 10);
                    gamesPlayed = games.length;
                    let hits = 0;
                    
                    games.forEach(game => {
                        let statValue = 0;
                        if (isGoalieMode) {
                            const shotsAgainst = game.shotsAgainst || 0;
                            const goalsAgainst = game.goalsAgainst || 0;
                            statValue = shotsAgainst - goalsAgainst;
                        } else {
                            if (currentStatType === 'points') statValue = game.points || 0;
                            else if (currentStatType === 'goals') statValue = game.goals || 0;
                            else if (currentStatType === 'assists') statValue = game.assists || 0;
                            else if (currentStatType === 'shots') statValue = game.shots || 0;
                        }
                        
                        if (statValue > lineValue) hits++;
                    });
                    
                    hitRate = (hits / games.length) * 100;
                }
                
                return { player, hasLine, hitRate, gamesPlayed };
            });
            
            const seenPlayerIds = new Set();
            const uniquePlayersWithHitRates = playersWithHitRates.filter(item => {
                if (seenPlayerIds.has(item.player.playerId)) {
                    return false;
                }
                seenPlayerIds.add(item.player.playerId);
                return true;
            });
            
            uniquePlayersWithHitRates.sort((a, b) => {
                if (a.hasLine && !b.hasLine) return -1;
                if (!a.hasLine && b.hasLine) return 1;
                
                if (a.hasLine && b.hasLine) {
                    if (a.gamesPlayed >= 4 && b.gamesPlayed >= 4) {
                        return b.hitRate - a.hitRate;
                    }
                    if (a.gamesPlayed >= 4 && b.gamesPlayed < 4) return -1;
                    if (a.gamesPlayed < 4 && b.gamesPlayed >= 4) return 1;
                    return (b.player.points || 0) - (a.player.points || 0);
                }
                
                return (b.player.points || 0) - (a.player.points || 0);
            });
            
            if (uniquePlayersWithHitRates.length === 0) {
                container.innerHTML = '<div class="loading">No players found.</div>';
                return;
            }
            
            let html = uniquePlayersWithHitRates.map(({player, hasLine}) => {
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown Goalie') : 
                    (player.skaterFullName || 'Unknown Player');
                const team = player.teamAbbrevs || 'N/A';
                const gamesPlayed = player.gamesPlayed || 0;
                
                let stat1Label, stat1Value, stat2Label, stat2Value, stat3Label, stat3Value;
                
                if (isGoalieMode) {
                    stat1Label = 'Saves';
                    stat1Value = player.saves || 0;
                    stat2Label = 'GAA';
                    stat2Value = (player.goalsAgainstAverage || 0).toFixed(2);
                    stat3Label = 'SV%';
                    stat3Value = (player.savePct || 0).toFixed(3);
                } else {
                    stat1Label = 'Goals';
                    stat1Value = player.goals || 0;
                    stat2Label = 'Assists';
                    stat2Value = player.assists || 0;
                    stat3Label = 'Points';
                    stat3Value = player.points || 0;
                }
                
                const position = isGoalieMode ? 'G' : (player.positionCode || 'N/A');
                
                const playerOdds = bettingOdds[name];
                let oddsDisplay = '';
                
                if (hasLine) {
                    // Get the line to display based on filter
                    let oddsInfo;
                    if (selectedLine) {
                        oddsInfo = playerOdds[currentStatType].find(l => l.line == parseFloat(selectedLine));
                    }
                    if (!oddsInfo) {
                        // When "All Lines" is selected, show the main/default line (not alternate)
                        oddsInfo = getMainLine(playerOdds[currentStatType]);
                    }
                    
                    const line = oddsInfo.line;
                    const price = oddsInfo.overOdds || oddsInfo.underOdds || 0; // Use overOdds if available, fallback to underOdds
                    const overOdds = oddsInfo.overOdds;
                    const underOdds = oddsInfo.underOdds;
                    const game = oddsInfo.game || 'N/A';
                    const gameTime = oddsInfo.gameTime || '';
                    const formattedOdds = price > 0 ? `+${price}` : price;
                    
                    if (currentStatType === 'goals' && oddsInfo.type === 'anytime_scorer') {
                        oddsDisplay = `<div class="odds-line" onclick="event.stopPropagation(); addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${line}, ${price}, '${game}', '${gameTime}')">Anytime Goal ${formattedOdds}</div>`;
                    } else {
                        // Display line and odds vertically stacked with individual click handlers
                        oddsDisplay = `<div style="display: flex; flex-direction: column; align-items: center; line-height: 1.2; gap: 2px; background: var(--warning-bg); padding: 8px; border-radius: 6px;">
                            <div style="font-weight: bold; font-size: 1.5em; color: #e67e22; pointer-events: none;">${line}</div>
                            ${overOdds ? `<div onclick="event.stopPropagation(); addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${line}, ${overOdds}, '${game}', '${gameTime}', 'over')" style="color: #27ae60; font-size: 1.1em; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#27ae60'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#27ae60';">O ${overOdds > 0 ? '+' : ''}${overOdds}</div>` : ''}
                            ${underOdds ? `<div onclick="event.stopPropagation(); addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${line}, ${underOdds}, '${game}', '${gameTime}', 'under')" style="color: #e74c3c; font-size: 1.1em; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#e74c3c';">U ${underOdds > 0 ? '+' : ''}${underOdds}</div>` : ''}
                        </div>`;
                    }
                }
                
                return `
                    <div class="player-card" onclick="showGameLog(${player.playerId})">
                        <div class="player-header">
                            <div style="flex: 1;">
                                <div class="player-name">${name}</div>
                                <div class="player-team" style="margin-top: 2px; margin-bottom: 0;">${team} - ${position} | GP: ${gamesPlayed}</div>
                            </div>
                            ${oddsDisplay}
                        </div>
                        <div class="player-stats" style="margin-top: 10px;">
                            <div class="stat">
                                <div class="stat-label">${stat1Label}</div>
                                <div class="stat-value">${stat1Value}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">${stat2Label}</div>
                                <div class="stat-value">${stat2Value}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">${stat3Label}</div>
                                <div class="stat-value">${stat3Value}</div>
                            </div>
                        </div>
                        <div class="hit-rate-display" id="hitrate-${player.playerId}">
                            <div class="stat-label">Calculating...</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            updateAllHitRates();
        }

        function displayTeams() {
            const container = document.getElementById('playersContainer');
            const hideStartedGames = document.getElementById('hideStartedGames').checked;
            const selectedGame = document.getElementById('gameFilter').value;
            const selectedLine = document.getElementById('lineFilter').value;
            const currentTime = new Date();
            
            // Get all unique teams from bettingOdds
            const teamsMap = new Map(); // Key: "teamName|game", Value: team data with all lines
            
            Object.keys(bettingOdds).forEach(teamKey => {
                const teamOdds = bettingOdds[teamKey];
                if (teamOdds && teamOdds.team_totals && teamOdds.team_totals.length > 0) {
                    // Get the game from the first line (they should all be the same game)
                    const firstLine = teamOdds.team_totals[0];
                    const game = firstLine.game;
                    const gameTime = firstLine.gameTime;
                    
                    // Check game filter
                    if (selectedGame && game !== selectedGame) return;
                    
                    // Check if game has started
                    if (hideStartedGames && gameTime) {
                        const gt = new Date(gameTime);
                        if (gt <= currentTime) return;
                    }
                    
                    // Combine team_totals and alternate_team_totals for filtering and display
                    const allLines = [...teamOdds.team_totals];
                    if (teamOdds.alternate_team_totals && teamOdds.alternate_team_totals.length > 0) {
                        allLines.push(...teamOdds.alternate_team_totals);
                    }
                    
                    // Check line filter - if set, only show teams that have this specific line
                    if (selectedLine) {
                        const hasLine = allLines.some(l => l.line == parseFloat(selectedLine));
                        if (!hasLine) return;
                    }
                    
                    // Store both main and alternate lines
                    const key = `${teamKey}|${game}`;
                    teamsMap.set(key, {
                        teamName: teamKey,
                        game: game,
                        gameTime: gameTime,
                        mainLines: teamOdds.team_totals,  // Main lines only
                        allLines: allLines  // All lines including alternates
                    });
                }
            });
            
            if (teamsMap.size === 0) {
                container.innerHTML = '<div class="loading">No team totals available</div>';
                return;
            }
            
            // Convert to array and sort by game time
            const teamsList = Array.from(teamsMap.values());
            teamsList.sort((a, b) => new Date(a.gameTime) - new Date(b.gameTime));
            
            const html = teamsList.map(teamData => {
                const { teamName, game, gameTime, mainLines, allLines } = teamData;
                
                // Get the main line to display on card
                let displayLine;
                if (selectedLine) {
                    // If line filter is set, use that specific line from ALL lines (including alternates)
                    displayLine = allLines.find(l => l.line == parseFloat(selectedLine));
                } else {
                    // Otherwise, use main team_totals lines only (NOT alternates)
                    displayLine = getMainLine(mainLines);
                }
                
                if (!displayLine) return ''; // Safety check
                
                const overOdds = displayLine.overOdds ? (displayLine.overOdds > 0 ? `+${displayLine.overOdds}` : displayLine.overOdds) : null;
                const underOdds = displayLine.underOdds ? (displayLine.underOdds > 0 ? `+${displayLine.underOdds}` : displayLine.underOdds) : null;
                const gameTimeStr = new Date(gameTime).toLocaleString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
                
                // Find team in teamShotData to get stats
                const teamStats = teamShotData.find(t => 
                    t.teamFullName === teamName || 
                    t.abbrev === teamName ||
                    t.teamFullName.includes(teamName)
                );
                
                const goalsPerGame = teamStats ? teamStats.goalsPerGame.toFixed(1) : 'N/A';
                const gamesPlayed = teamStats ? teamStats.gamesPlayed : 0;
                
                return `
                    <div class="player-card" onclick="showTeamLog('${teamName}', '${game}')">
                        <div class="player-header">
                            <div class="player-name">${teamName}</div>
                            <div class="odds-line" style="display: flex; flex-direction: column; align-items: center; line-height: 1.2; gap: 2px;">
                                <div style="font-weight: bold; font-size: 1.5em; color: #e67e22;">${displayLine.line}</div>
                                ${overOdds ? `<div onclick="event.stopPropagation(); addToWatchlist('team-${teamName.replace(/\s+/g, '-')}', '${teamName}', 'team_totals', ${displayLine.line}, ${displayLine.overOdds}, '${game}', '${gameTime}', 'over')" style="color: #27ae60; font-size: 1.1em; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#27ae60'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#27ae60';">O ${overOdds}</div>` : ''}
                                ${underOdds ? `<div onclick="event.stopPropagation(); addToWatchlist('team-${teamName.replace(/\s+/g, '-')}', '${teamName}', 'team_totals', ${displayLine.line}, ${displayLine.underOdds}, '${game}', '${gameTime}', 'under')" style="color: #e74c3c; font-size: 1.1em; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#e74c3c';">U ${underOdds}</div>` : ''}
                            </div>
                        </div>
                        <div class="player-team">${game}</div>
                        <div class="player-stats">
                            <div class="stat">
                                <div class="stat-label">Season Avg</div>
                                <div class="stat-value">${goalsPerGame}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Games Played</div>
                                <div class="stat-value">${gamesPlayed}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Game Time</div>
                                <div class="stat-value" style="font-size: 0.8em;">${gameTimeStr}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function updateAllHitRates() {
            const selectedLine = document.getElementById('lineFilter').value;
            
            filteredPlayers.forEach(player => {
                const name = isGoalieMode ? 
                    (player.goalieFullName || 'Unknown Goalie') : 
                    (player.skaterFullName || 'Unknown Player');
                const playerOdds = bettingOdds[name];
                let lineValue = 0.5;
                
                if (playerOdds && Array.isArray(playerOdds[currentStatType]) && playerOdds[currentStatType].length > 0) {
                    // Use filtered line if selected, otherwise use main/default line
                    if (selectedLine) {
                        const matchingLine = playerOdds[currentStatType].find(l => l.line == parseFloat(selectedLine));
                        lineValue = matchingLine ? matchingLine.line : getMainLine(playerOdds[currentStatType]).line;
                    } else {
                        lineValue = getMainLine(playerOdds[currentStatType]).line;
                    }
                }
                
                const gameLogSource = isGoalieMode ? allGoalieGameLogs : allGameLogs;
                const gameLog = gameLogSource[player.playerId];
                
                if (!gameLog || !gameLog.gameLog || gameLog.gameLog.length === 0) {
                    const hitRateDiv = document.getElementById(`hitrate-${player.playerId}`);
                    if (hitRateDiv) {
                        hitRateDiv.innerHTML = `<div class="stat-label">No game log available</div>`;
                    }
                    playerHitRates[player.playerId] = 0;
                    return;
                }

                let games = gameLog.gameLog;
                if (isGoalieMode) {
                    games = games.filter(game => {
                        const shotsAgainst = game.shotsAgainst || 0;
                        const gamesStarted = game.gamesStarted || 0;
                        return gamesStarted > 0 || shotsAgainst > 0;
                    });
                }
                games = games.slice(0, 10);
                let hits = 0;

                games.forEach(game => {
                    let statValue = 0;
                    if (isGoalieMode) {
                        const shotsAgainst = game.shotsAgainst || 0;
                        const goalsAgainst = game.goalsAgainst || 0;
                        statValue = shotsAgainst - goalsAgainst;
                    } else {
                        if (currentStatType === 'points') statValue = game.points || 0;
                        else if (currentStatType === 'goals') statValue = game.goals || 0;
                        else if (currentStatType === 'assists') statValue = game.assists || 0;
                        else if (currentStatType === 'shots') statValue = game.shots || 0;
                    }
                    
                    if (statValue > lineValue) hits++;
                });

                const hitRate = games.length > 0 ? ((hits / games.length) * 100).toFixed(1) : 0;
                playerHitRates[player.playerId] = parseFloat(hitRate);
                
                const hitRateDiv = document.getElementById(`hitrate-${player.playerId}`);
                const colorClass = getHitRateColor(parseFloat(hitRate));
                
                if (hitRateDiv) {
                    hitRateDiv.innerHTML = `
                        <div class="stat-label">Last ${games.length} Games vs ${lineValue}</div>
                        <div class="hit-rate-value ${colorClass}">${hitRate}% (${hits}/${games.length})</div>
                    `;
                }
            });
        }

        function calculateH2HStats(games, opponent) {
            const h2hGames = games.filter(game => game.opponentAbbrev === opponent);
            
            if (h2hGames.length === 0) return null;
            
            // Check if these are goalie games (have shotsAgainst field)
            const isGoalieStats = h2hGames[0].shotsAgainst !== undefined;
            
            if (isGoalieStats) {
                // Goalie-specific stats
                let totalSaves = 0;
                let totalShotsAgainst = 0;
                let totalGoalsAgainst = 0;
                let wins = 0;
                let losses = 0;
                
                h2hGames.forEach(game => {
                    const shotsAgainst = game.shotsAgainst || 0;
                    const goalsAgainst = game.goalsAgainst || 0;
                    const saves = shotsAgainst - goalsAgainst;
                    
                    totalSaves += saves;
                    totalShotsAgainst += shotsAgainst;
                    totalGoalsAgainst += goalsAgainst;
                    
                    if (game.decision === 'W') wins++;
                    if (game.decision === 'L') losses++;
                });
                
                const avgSavePct = totalShotsAgainst > 0 ? (totalSaves / totalShotsAgainst) : 0;
                
                return {
                    games: h2hGames.length,
                    avgSaves: (totalSaves / h2hGames.length).toFixed(1),
                    avgShotsAgainst: (totalShotsAgainst / h2hGames.length).toFixed(1),
                    avgGoalsAgainst: (totalGoalsAgainst / h2hGames.length).toFixed(2),
                    avgSavePct: (avgSavePct * 100).toFixed(1),
                    wins,
                    losses,
                    isGoalie: true,
                    opponentAbbrev: opponent
                };
            } else {
                // Skater stats
                let totalGoals = 0;
                let totalAssists = 0;
                let totalPoints = 0;
                let totalShots = 0;
                
                h2hGames.forEach(game => {
                    totalGoals += game.goals || 0;
                    totalAssists += game.assists || 0;
                    totalPoints += game.points || 0;
                    totalShots += game.shots || 0;
                });
                
                return {
                    games: h2hGames.length,
                    avgGoals: (totalGoals / h2hGames.length).toFixed(2),
                    avgAssists: (totalAssists / h2hGames.length).toFixed(2),
                    avgPoints: (totalPoints / h2hGames.length).toFixed(2),
                    avgShots: (totalShots / h2hGames.length).toFixed(2),
                    totalGoals,
                    totalAssists,
                    totalPoints,
                    isGoalie: false
                };
            }
        }

        function showGameLog(playerId) {
            const gameLogSource = isGoalieMode ? allGoalieGameLogs : allGameLogs;
            const playerSource = isGoalieMode ? allGoaliesData : allPlayersData;
            
            const gameLog = gameLogSource[playerId];
            
            if (!gameLog || !gameLog.gameLog || gameLog.gameLog.length === 0) {
                alert('Game log not available for this player');
                return;
            }

            const player = playerSource.find(p => p.playerId === playerId);
            const name = isGoalieMode ? 
                (player.goalieFullName || 'Unknown Goalie') : 
                (player.skaterFullName || 'Unknown Player');
            
            const playerOdds = bettingOdds[name];
            const selectedLine = document.getElementById('lineFilter').value;
            let lineValue = 0.5;
            let nextOpponent = null;
            
            if (playerOdds && Array.isArray(playerOdds[currentStatType]) && playerOdds[currentStatType].length > 0) {
                // Use filtered line if selected, otherwise use main/default line
                let lineObj;
                if (selectedLine) {
                    lineObj = playerOdds[currentStatType].find(l => l.line == parseFloat(selectedLine));
                }
                if (!lineObj) {
                    lineObj = getMainLine(playerOdds[currentStatType]);
                }
                
                if (lineObj) {
                    lineValue = lineObj.line;
                    const gameStr = lineObj.game;
                    const teams = gameStr.split(' vs ');
                    const playerTeamFull = player.teamAbbrevs;
                    
                    const teamFullNames = {
                        'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                        'FLA': 'Florida Panthers', 'MTL': 'Montreal Canadiens', 'OTT': 'Ottawa Senators',
                        'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                        'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                        'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                        'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                        'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                        'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                        'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                        'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                        'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Mammoth', 'UTH': 'Utah Mammoth'
                    };
                    
                    const playerTeamFullName = teamFullNames[playerTeamFull];
                    
                    if (playerTeamFullName && teams[0].trim() === playerTeamFullName) {
                        nextOpponent = teams[1].trim();
                    } else {
                        nextOpponent = teams[0].trim();
                    }
                    
                    console.log('Next opponent detected:', nextOpponent);
                }
            }

            let games = gameLog.gameLog;
            if (isGoalieMode) {
                games = games.filter(game => {
                    const shotsAgainst = game.shotsAgainst || 0;
                    const gamesStarted = game.gamesStarted || 0;
                    return gamesStarted > 0 || shotsAgainst > 0;
                });
            }
            games = games.slice(0, 10);
            let hits = 0;

            const gameRows = games.map(game => {
                let statValue = 0;
                
                if (isGoalieMode) {
                    const shotsAgainst = game.shotsAgainst || 0;
                    const goalsAgainst = game.goalsAgainst || 0;
                    statValue = shotsAgainst - goalsAgainst;
                } else {
                    if (currentStatType === 'points') statValue = game.points || 0;
                    else if (currentStatType === 'goals') statValue = game.goals || 0;
                    else if (currentStatType === 'assists') statValue = game.assists || 0;
                    else if (currentStatType === 'shots') statValue = game.shots || 0;
                }

                const hit = statValue > lineValue;
                if (hit) hits++;

                const opponent = game.opponentAbbrev || 'N/A';
                const homeAway = game.homeRoadFlag === 'H' ? 'vs' : '@';
                // Fix timezone issue: parse date string as local date, not UTC
                const [year, month, day] = game.gameDate.split('-');
                const gameDate = new Date(year, month - 1, day).toLocaleDateString();

                if (isGoalieMode) {
                    const teamFullNames = {
                        'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                        'FLA': 'Florida Panthers', 'MTL': 'Montreal Canadiens', 'OTT': 'Ottawa Senators',
                        'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                        'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                        'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                        'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                        'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                        'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                        'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                        'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                        'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Mammoth', 'UTH': 'Utah Mammoth'
                    };
                    
                    const teamMascots = {
                        'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                        'Florida Panthers': 'Panthers', 'Montreal Canadiens': 'Canadiens', 'Ottawa Senators': 'Senators',
                        'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 'New York Rangers': 'Rangers',
                        'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 'Pittsburgh Penguins': 'Penguins',
                        'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 'Columbus Blue Jackets': 'Blue Jackets',
                        'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 'Winnipeg Jets': 'Jets',
                        'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                        'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                        'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                        'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                        'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth'
                    };
                    
                    const oppTeamName = teamFullNames[opponent];
                    let oppTeamData = teamShotData.find(t => t.teamFullName === oppTeamName);
                    
                    if (!oppTeamData) {
                        oppTeamData = teamShotData.find(t => 
                            t.abbrev === opponent || 
                            t.teamFullName.includes(opponent) ||
                            (oppTeamName && oppTeamName.includes(t.abbrev)) ||
                            normalizeTeamName(t.teamFullName) === normalizeTeamName(oppTeamName) ||
                            (opponent === 'UTA' && t.teamFullName.includes('Utah')) ||
                            (opponent === 'UTH' && t.teamFullName.includes('Utah'))
                        );
                    }
                    
                    let shotRankBadge = '';
                    if (oppTeamData) {
                        let badgeColor = '#27ae60';
                        if (oppTeamData.rank <= 10) {
                            badgeColor = '#e74c3c';
                        } else if (oppTeamData.rank <= 22) {
                            badgeColor = '#f39c12';
                        }
                        shotRankBadge = `<span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin-left: 5px;">#${oppTeamData.rank}</span>`;
                    }
                    
                    const shotsAgainst = game.shotsAgainst || 0;
                    const goalsAgainst = game.goalsAgainst || 0;
                    const saves = shotsAgainst - goalsAgainst;
                    const savePct = game.savePctg ? (game.savePctg * 100).toFixed(1) + '%' : 'N/A';
                    
                    return `
                        <tr class="${hit ? 'hit' : 'miss'}">
                            <td>${gameDate}</td>
                            <td>${homeAway} ${opponent} ${shotRankBadge}</td>
                            <td>${saves}</td>
                            <td>${shotsAgainst}</td>
                            <td>${goalsAgainst}</td>
                            <td>${savePct}</td>
                            <td>${game.decision || 'N/A'}</td>
                        </tr>
                    `;
                } else {
                    let oppDefenseInfo = '';
                    if (currentStatType === 'shots') {
                        const teamFullNames = {
                            'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                            'FLA': 'Florida Panthers', 'MTL': 'Montreal Canadiens', 'OTT': 'Ottawa Senators',
                            'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                            'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                            'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                            'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                            'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                            'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                            'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                            'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                            'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Mammoth'
                        };
                        
                        const teamMascots = {
                            'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                            'Florida Panthers': 'Panthers', 'Montreal Canadiens': 'Canadiens', 'Ottawa Senators': 'Senators',
                            'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 'New York Rangers': 'Rangers',
                            'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 'Pittsburgh Penguins': 'Penguins',
                            'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 'Columbus Blue Jackets': 'Blue Jackets',
                            'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 'Winnipeg Jets': 'Jets',
                            'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                            'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                            'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                            'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                            'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth'
                        };
                        
                        const oppTeamName = teamFullNames[opponent];
                        let oppTeamData = teamShotData.find(t => t.teamFullName === oppTeamName);
                        
                        if (!oppTeamData) {
                            oppTeamData = teamShotData.find(t => 
                                t.abbrev === opponent || 
                                t.teamFullName.includes(opponent) ||
                                oppTeamName.includes(t.abbrev) ||
                                normalizeTeamName(t.teamFullName) === normalizeTeamName(oppTeamName)
                            );
                        }
                        
                        if (oppTeamData) {
                            const mascot = teamMascots[oppTeamName] || teamMascots[oppTeamData.teamFullName] || opponent;
                            let badgeColor = '#e74c3c';
                            if (oppTeamData.defensiveRank <= 10) {
                                badgeColor = '#27ae60';
                            } else if (oppTeamData.defensiveRank <= 22) {
                                badgeColor = '#f39c12';
                            }
                            oppDefenseInfo = ` <span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold;">${mascot} allow ${oppTeamData.shotsAgainstPerGame.toFixed(1)}/g</span>`;
                        }
                    }
                    
                    return `
                        <tr class="${hit ? 'hit' : 'miss'}">
                            <td>${gameDate}</td>
                            <td>${homeAway} ${opponent}${oppDefenseInfo}</td>
                            <td${currentStatType === 'goals' ? ' style="font-weight: bold;"' : ''}>${game.goals || 0}</td>
                            <td${currentStatType === 'assists' ? ' style="font-weight: bold;"' : ''}>${game.assists || 0}</td>
                            <td${currentStatType === 'points' ? ' style="font-weight: bold;"' : ''}>${game.points || 0}</td>
                            <td${currentStatType === 'shots' ? ' style="font-weight: bold;"' : ''}>${game.shots || 0}</td>
                        </tr>
                    `;
                }
            }).join('');

            const hitRate = ((hits / games.length) * 100).toFixed(1);
            const colorClass = getHitRateColor(parseFloat(hitRate));
            
            let h2hSection = '';
            if (nextOpponent) {
                const allGames = gameLog.gameLog;
                const h2hStats = calculateH2HStats(allGames, nextOpponent);
                
                console.log('H2H Stats:', h2hStats);
                
                if (h2hStats && h2hStats.games > 0) {
                    const h2hHitRate = calculateH2HHitRate(allGames, h2hStats.opponentAbbrev, lineValue);
                    const h2hColorClass = getHitRateColor(h2hHitRate);
                    
                    if (h2hStats.isGoalie) {
                        // Goalie H2H stats
                        h2hSection = `
                            <div class="h2h-section">
                                <div class="h2h-title">📊 Head-to-Head vs ${nextOpponent} (Last ${h2hStats.games} games)</div>
                                <div class="h2h-stats">
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Games</div>
                                        <div class="h2h-stat-value">${h2hStats.games}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Record</div>
                                        <div class="h2h-stat-value">${h2hStats.wins}-${h2hStats.losses}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg Saves</div>
                                        <div class="h2h-stat-value">${h2hStats.avgSaves}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg Shots Against</div>
                                        <div class="h2h-stat-value">${h2hStats.avgShotsAgainst}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg Goals Against</div>
                                        <div class="h2h-stat-value">${h2hStats.avgGoalsAgainst}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg SV%</div>
                                        <div class="h2h-stat-value">${h2hStats.avgSavePct}%</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Hit Rate vs ${lineValue}</div>
                                        <div class="h2h-stat-value ${h2hColorClass}">${h2hHitRate.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Skater H2H stats
                        h2hSection = `
                            <div class="h2h-section">
                                <div class="h2h-title">📊 Head-to-Head vs ${nextOpponent} (Last ${h2hStats.games} games)</div>
                                <div class="h2h-stats">
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Games</div>
                                        <div class="h2h-stat-value">${h2hStats.games}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg Goals</div>
                                        <div class="h2h-stat-value">${h2hStats.avgGoals}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg Assists</div>
                                        <div class="h2h-stat-value">${h2hStats.avgAssists}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg Points</div>
                                        <div class="h2h-stat-value">${h2hStats.avgPoints}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Avg Shots</div>
                                        <div class="h2h-stat-value">${h2hStats.avgShots}</div>
                                    </div>
                                    <div class="h2h-stat">
                                        <div class="h2h-stat-label">Hit Rate vs ${lineValue}</div>
                                        <div class="h2h-stat-value ${h2hColorClass}">${h2hHitRate.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    h2hSection = `
                        <div class="h2h-section" style="background: var(--card-bg); border: 2px dashed var(--input-border);">
                            <div class="h2h-title" style="color: var(--text-secondary);">📊 Head-to-Head vs ${nextOpponent}</div>
                            <div style="text-align: center; padding: 15px; color: var(--text-secondary); font-style: italic;">
                                No previous games vs ${nextOpponent} this season
                            </div>
                        </div>
                    `;
                    console.log('No H2H games found for opponent:', nextOpponent);
                }
            }
            
            let oddsCard = '';
            if (playerOdds && Array.isArray(playerOdds[currentStatType]) && playerOdds[currentStatType].length > 0) {
                const allLines = playerOdds[currentStatType];
                
                // Calculate hit rate for each line
                const linesWithHitRates = allLines.map(lineObj => {
                    let hits = 0;
                    games.forEach(game => {
                        let statValue = 0;
                        if (isGoalieMode) {
                            const shotsAgainst = game.shotsAgainst || 0;
                            const goalsAgainst = game.goalsAgainst || 0;
                            statValue = shotsAgainst - goalsAgainst;
                        } else {
                            if (currentStatType === 'points') statValue = game.points || 0;
                            else if (currentStatType === 'goals') statValue = game.goals || 0;
                            else if (currentStatType === 'assists') statValue = game.assists || 0;
                            else if (currentStatType === 'shots') statValue = game.shots || 0;
                        }
                        if (statValue > lineObj.line) hits++;
                    });
                    
                    const hitRate = games.length > 0 ? ((hits / games.length) * 100).toFixed(1) : 0;
                    const colorClass = getHitRateColor(parseFloat(hitRate));
                    
                    return {
                        ...lineObj,
                        hits,
                        hitRate,
                        colorClass
                    };
                });
                
                if (linesWithHitRates.length === 1) {
                    // Single line - show traditional card
                    const lineData = linesWithHitRates[0];
                    const formattedOdds = (lineData.overOdds || lineData.underOdds || 0) > 0 ? `+${lineData.overOdds || lineData.underOdds}` : (lineData.overOdds || lineData.underOdds);
                    
                    let oddsLabel = 'Betting Line';
                    let oddsValue = `O/U ${lineData.line} ${formattedOdds}`;
                    
                    if (currentStatType === 'goals' && lineData.type === 'anytime_scorer') {
                        oddsLabel = 'Anytime Goal Scorer';
                        oddsValue = formattedOdds;
                    }
                    
                    const inWatchlist = isInWatchlist(player.playerId, currentStatType);
                    const watchlistText = inWatchlist ? '⭐ Added to Watchlist' : 'Click to add to Watchlist';
                    
                    oddsCard = `
                        <div class="summary-card" onclick="addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${lineData.line}, ${lineData.overOdds || lineData.underOdds}, '${lineData.game}', '${lineData.gameTime}')" style="cursor: pointer; transition: all 0.2s;">
                            <div class="summary-label">${oddsLabel}</div>
                            ${currentStatType === 'goals' && lineData.type === 'anytime_scorer' ? `
                                <div class="summary-value" style="color: #e67e22; font-size: 1.5em;">${oddsValue}</div>
                            ` : `
                                <div style="display: flex; flex-direction: column; align-items: center; margin-top: 10px; gap: 4px;">
                                    <div style="color: #e67e22; font-size: 2em; font-weight: bold;">${lineData.line}</div>
                                    ${lineData.overOdds !== undefined ? `
                                        <div onclick="event.stopPropagation(); addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${lineData.line}, ${lineData.overOdds}, '${lineData.game}', '${lineData.gameTime}', 'over')" style="color: #27ae60; font-size: 1.3em; font-weight: 600; cursor: pointer; padding: 4px 12px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#27ae60'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#27ae60';">O ${lineData.overOdds > 0 ? '+' : ''}${lineData.overOdds}</div>
                                    ` : ''}
                                    ${lineData.underOdds !== undefined ? `
                                        <div onclick="event.stopPropagation(); addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${lineData.line}, ${lineData.underOdds}, '${lineData.game}', '${lineData.gameTime}', 'under')" style="color: #e74c3c; font-size: 1.3em; font-weight: 600; cursor: pointer; padding: 4px 12px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#e74c3c';">U ${lineData.underOdds > 0 ? '+' : ''}${lineData.underOdds}</div>
                                    ` : ''}
                                </div>
                            `}
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">${watchlistText}</div>
                        </div>
                    `;
                } else {
                    // Multiple lines - show all with hit rates
                    oddsCard = `
                        <div class="summary-card" style="grid-column: 1 / -1;">
                            <div class="collapsible-header" onclick="toggleAvailableLines(this)">
                                <div class="summary-label">Available Lines (${linesWithHitRates.length}) - Click any line to add to watchlist</div>
                                <span class="toggle-arrow">▼</span>
                            </div>
                            <div class="collapsible-content">
                                ${linesWithHitRates.map(lineData => {
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--card-bg); margin: 5px 0; border-radius: 6px; border-left: 3px solid #e67e22; transition: all 0.2s;">
                                            <div style="display: flex; align-items: center; gap: 15px;">
                                                <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px; gap: 3px;">
                                                    <div style="font-weight: bold; color: #e67e22; font-size: 1.4em;">${lineData.line}</div>
                                                    ${lineData.overOdds ? `<div onclick="event.stopPropagation(); addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${lineData.line}, ${lineData.overOdds}, '${lineData.game}', '${lineData.gameTime}', 'over')" style="color: #27ae60; font-size: 1em; font-weight: 600; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#27ae60'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#27ae60';">O ${lineData.overOdds > 0 ? '+' : ''}${lineData.overOdds}</div>` : ''}
                                                    ${lineData.underOdds ? `<div onclick="event.stopPropagation(); addToWatchlist(${player.playerId}, '${name.replace(/'/g, "\\'")}', '${currentStatType}', ${lineData.line}, ${lineData.underOdds}, '${lineData.game}', '${lineData.gameTime}', 'under')" style="color: #e74c3c; font-size: 1em; font-weight: 600; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#e74c3c';">U ${lineData.underOdds > 0 ? '+' : ''}${lineData.underOdds}</div>` : ''}
                                                </div>
                                                <span style="color: var(--text-secondary); font-size: 0.8em;">(${lineData.bookmaker})</span>
                                            </div>
                                            <div>
                                                <span class="${lineData.colorClass}" style="font-weight: bold; font-size: 1em;">${lineData.hitRate}%</span>
                                                <span style="color: var(--text-secondary); font-size: 0.9em; margin-left: 5px;">(${lineData.hits}/${games.length})</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }

            const modalContent = document.getElementById('modalContent');
            
            const hasLines = playerOdds && Array.isArray(playerOdds[currentStatType]) && playerOdds[currentStatType].length > 0;
            const inWatchlist = hasLines && isInWatchlist(player.playerId, currentStatType);
            
            // Get the main/default line for display in modal
            const mainLine = hasLines ? getMainLine(playerOdds[currentStatType]) : null;
            
            modalContent.innerHTML = `
                <h2>${name}</h2>
                <p>${player.teamAbbrevs} - ${isGoalieMode ? 'G' : player.positionCode}</p>
                
                <div class="summary-stats">
                    <div class="summary-card">
                        <div class="summary-label">Hit Rate</div>
                        <div class="summary-value ${colorClass}">${hitRate}%</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Hits</div>
                        <div class="summary-value">${hits}/${games.length}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">${isGoalieMode ? 'Season Saves' : 'Season Points'}</div>
                        <div class="summary-value">${isGoalieMode ? (player.saves || 0) : (player.points || 0)}</div>
                    </div>
                    ${oddsCard}
                </div>
                
                ${hasLines && mainLine ? `
                    <div style="background: var(--warning-bg); padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; transition: all 0.3s ease;">
                        <div style="font-size: 0.9em; color: var(--warning-text); margin-bottom: 5px; font-weight: 600;">🏒 This Game</div>
                        <div style="font-size: 1.2em; font-weight: bold; color: var(--text-primary);">${mainLine.game}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">${new Date(mainLine.gameTime).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 3px;">Odds from ${mainLine.bookmaker}</div>
                        ${isGoalieMode && nextOpponent ? (() => {
                            const oppTeamData = teamShotData.find(t => t.teamFullName === nextOpponent);
                            if (oppTeamData) {
                                // Also get goalie's team defensive stats
                                const teamNamesMap = {
                                    'TOR': 'Toronto Maple Leafs', 'BOS': 'Boston Bruins', 'TBL': 'Tampa Bay Lightning',
                                    'FLA': 'Florida Panthers', 'MTL': 'Montreal Canadiens', 'OTT': 'Ottawa Senators',
                                    'BUF': 'Buffalo Sabres', 'DET': 'Detroit Red Wings', 'NYR': 'New York Rangers',
                                    'NYI': 'New York Islanders', 'NJD': 'New Jersey Devils', 'PIT': 'Pittsburgh Penguins',
                                    'WSH': 'Washington Capitals', 'PHI': 'Philadelphia Flyers', 'CBJ': 'Columbus Blue Jackets',
                                    'CAR': 'Carolina Hurricanes', 'NSH': 'Nashville Predators', 'WPG': 'Winnipeg Jets',
                                    'MIN': 'Minnesota Wild', 'COL': 'Colorado Avalanche', 'DAL': 'Dallas Stars',
                                    'CHI': 'Chicago Blackhawks', 'STL': 'St. Louis Blues', 'VGK': 'Vegas Golden Knights',
                                    'EDM': 'Edmonton Oilers', 'CGY': 'Calgary Flames', 'VAN': 'Vancouver Canucks',
                                    'SEA': 'Seattle Kraken', 'SJS': 'San Jose Sharks', 'ANA': 'Anaheim Ducks',
                                    'LAK': 'Los Angeles Kings', 'ARI': 'Arizona Coyotes', 'UTA': 'Utah Mammoth', 'UTH': 'Utah Mammoth'
                                };
                                
                                const teamMascots = {
                                    'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                                    'Florida Panthers': 'Panthers', 'Montreal Canadiens': 'Canadiens', 'Ottawa Senators': 'Senators',
                                    'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 'New York Rangers': 'Rangers',
                                    'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 'Pittsburgh Penguins': 'Penguins',
                                    'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 'Columbus Blue Jackets': 'Blue Jackets',
                                    'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 'Winnipeg Jets': 'Jets',
                                    'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                                    'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                                    'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                                    'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                                    'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth'
                                };
                                
                                const oppMascot = teamMascots[nextOpponent] || nextOpponent.split(' ').pop();
                                
                                const goalieTeamFullName = teamNamesMap[player.teamAbbrevs];
                                const goalieTeamData = teamShotData.find(t => 
                                    t.teamFullName === goalieTeamFullName || 
                                    t.abbrev === player.teamAbbrevs
                                );
                                
                                let goalieTeamInfo = '';
                                if (goalieTeamData) {
                                    const mascot = teamMascots[goalieTeamFullName] || player.teamAbbrevs;
                                    goalieTeamInfo = `<div style="font-size: 0.95em; color: var(--text-primary); margin-top: 5px; font-weight: 600;">${mascot} allow ${goalieTeamData.shotsAgainstPerGame.toFixed(1)} shots/game | ${getOrdinal(goalieTeamData.defensiveRank)} in NHL</div>`;
                                }
                                
                                return `<div style="font-size: 0.95em; color: var(--text-primary); margin-top: 8px; font-weight: 600;">🎯 ${oppMascot} take ${oppTeamData.shotsPerGame.toFixed(1)} shots/game | ${getOrdinal(oppTeamData.rank)} in NHL</div>${goalieTeamInfo}`;
                            }
                            return '';
                        })() : !isGoalieMode && currentStatType === 'shots' && nextOpponent ? (() => {
                            const teamMascots = {
                                'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                                'Florida Panthers': 'Panthers', 'Montreal Canadiens': 'Canadiens', 'Ottawa Senators': 'Senators',
                                'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 'New York Rangers': 'Rangers',
                                'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 'Pittsburgh Penguins': 'Penguins',
                                'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 'Columbus Blue Jackets': 'Blue Jackets',
                                'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 'Winnipeg Jets': 'Jets',
                                'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                                'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                                'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                                'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                                'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth'
                            };
                            let oppTeamData = teamShotData.find(t => t.teamFullName === nextOpponent);
                            if (!oppTeamData) {
                                oppTeamData = teamShotData.find(t => 
                                    t.teamFullName.includes(nextOpponent.split(' ').pop()) ||
                                    nextOpponent.includes(t.teamFullName) ||
                                    normalizeTeamName(t.teamFullName) === normalizeTeamName(nextOpponent) ||
                                    (nextOpponent.includes('Utah') && t.teamFullName.includes('Utah'))
                                );
                            }
                            if (oppTeamData) {
                                const mascot = teamMascots[nextOpponent] || teamMascots[oppTeamData.teamFullName] || nextOpponent.split(' ').pop();
                                return `<div style="font-size: 0.95em; color: var(--text-primary); margin-top: 8px; font-weight: 600;">🎯 ${mascot} allow ${oppTeamData.shotsAgainstPerGame.toFixed(1)} shots/game | ${getOrdinal(oppTeamData.defensiveRank)} most</div>`;
                            }
                            return '';
                        })() : !isGoalieMode && currentStatType === 'goals' && nextOpponent ? (() => {
                            const teamMascots = {
                                'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                                'Florida Panthers': 'Panthers', 'Montreal Canadiens': 'Canadiens', 'Ottawa Senators': 'Senators',
                                'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 'New York Rangers': 'Rangers',
                                'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 'Pittsburgh Penguins': 'Penguins',
                                'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 'Columbus Blue Jackets': 'Blue Jackets',
                                'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 'Winnipeg Jets': 'Jets',
                                'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                                'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                                'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                                'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                                'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth'
                            };
                            let oppTeamData = teamShotData.find(t => t.teamFullName === nextOpponent);
                            if (!oppTeamData) {
                                oppTeamData = teamShotData.find(t => 
                                    t.teamFullName.includes(nextOpponent.split(' ').pop()) ||
                                    nextOpponent.includes(t.teamFullName) ||
                                    normalizeTeamName(t.teamFullName) === normalizeTeamName(nextOpponent) ||
                                    (nextOpponent.includes('Utah') && t.teamFullName.includes('Utah'))
                                );
                            }
                            if (oppTeamData && oppTeamData.goalsAgainstPerGame !== undefined && oppTeamData.goalsAgainstRank) {
                                const mascot = teamMascots[nextOpponent] || teamMascots[oppTeamData.teamFullName] || nextOpponent.split(' ').pop();
                                return `<div style="font-size: 0.95em; color: var(--text-primary); margin-top: 8px; font-weight: 600;">🎯 ${mascot} allow ${oppTeamData.goalsAgainstPerGame.toFixed(1)} goals/game | ${getOrdinal(oppTeamData.goalsAgainstRank)} most</div>`;
                            }
                            return '';
                        })() : !isGoalieMode && (currentStatType === 'points' || currentStatType === 'assists') && nextOpponent ? (() => {
                            const teamMascots = {
                                'Toronto Maple Leafs': 'Maple Leafs', 'Boston Bruins': 'Bruins', 'Tampa Bay Lightning': 'Lightning',
                                'Florida Panthers': 'Panthers', 'Montreal Canadiens': 'Canadiens', 'Ottawa Senators': 'Senators',
                                'Buffalo Sabres': 'Sabres', 'Detroit Red Wings': 'Red Wings', 'New York Rangers': 'Rangers',
                                'New York Islanders': 'Islanders', 'New Jersey Devils': 'Devils', 'Pittsburgh Penguins': 'Penguins',
                                'Washington Capitals': 'Capitals', 'Philadelphia Flyers': 'Flyers', 'Columbus Blue Jackets': 'Blue Jackets',
                                'Carolina Hurricanes': 'Hurricanes', 'Nashville Predators': 'Predators', 'Winnipeg Jets': 'Jets',
                                'Minnesota Wild': 'Wild', 'Colorado Avalanche': 'Avalanche', 'Dallas Stars': 'Stars',
                                'Chicago Blackhawks': 'Blackhawks', 'St. Louis Blues': 'Blues', 'Vegas Golden Knights': 'Golden Knights',
                                'Edmonton Oilers': 'Oilers', 'Calgary Flames': 'Flames', 'Vancouver Canucks': 'Canucks',
                                'Seattle Kraken': 'Kraken', 'San Jose Sharks': 'Sharks', 'Anaheim Ducks': 'Ducks',
                                'Los Angeles Kings': 'Kings', 'Arizona Coyotes': 'Coyotes', 'Utah Mammoth': 'Mammoth'
                            };
                            let oppTeamData = teamShotData.find(t => t.teamFullName === nextOpponent);
                            if (!oppTeamData) {
                                oppTeamData = teamShotData.find(t => 
                                    t.teamFullName.includes(nextOpponent.split(' ').pop()) ||
                                    nextOpponent.includes(t.teamFullName) ||
                                    normalizeTeamName(t.teamFullName) === normalizeTeamName(nextOpponent) ||
                                    (nextOpponent.includes('Utah') && t.teamFullName.includes('Utah'))
                                );
                            }
                            if (oppTeamData && oppTeamData.pointsAgainstPerGame !== undefined && oppTeamData.pointsAgainstRank) {
                                const mascot = teamMascots[nextOpponent] || teamMascots[oppTeamData.teamFullName] || nextOpponent.split(' ').pop();
                                const statLabel = currentStatType === 'points' ? 'points' : 'assists';
                                return `<div style="font-size: 0.95em; color: var(--text-primary); margin-top: 8px; font-weight: 600;">🎯 ${mascot} allow ${oppTeamData.pointsAgainstPerGame.toFixed(1)} ${statLabel}/game | ${getOrdinal(oppTeamData.pointsAgainstRank)} most</div>`;
                            }
                            return '';
                        })() : ''}
                    </div>
                ` : ''}
                
                ${h2hSection}

                <h3>Last ${games.length} Games</h3>
                ${isGoalieMode ? `
                    <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.85em; color: var(--text-secondary);">
                        <strong>Badge Colors:</strong> 
                        <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; margin: 0 3px;">#1-10</span> High shot volume (more work) 
                        <span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 3px; margin: 0 3px;">#11-22</span> Medium 
                        <span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 3px; margin: 0 3px;">#23-32</span> Low shot volume (easier)
                    </div>
                ` : currentStatType === 'shots' ? `
                    <div style="background: var(--card-bg); padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.85em; color: var(--text-secondary);">
                        <strong>Badge Colors:</strong> 
                        <span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 3px; margin: 0 3px;">#1-10</span> Allow most shots (easier) 
                        <span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 3px; margin: 0 3px;">#11-22</span> Medium 
                        <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; margin: 0 3px;">#23-32</span> Allow fewest shots (harder)
                    </div>
                ` : ''}
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            ${isGoalieMode ? `
                                <th>Saves</th>
                                <th>Shots Against</th>
                                <th>GA</th>
                                <th>SV%</th>
                                <th>Decision</th>
                            ` : `
                                <th${currentStatType === 'goals' ? ' style="font-weight: bold; color: #e67e22;"' : ''}>Goals</th>
                                <th${currentStatType === 'assists' ? ' style="font-weight: bold; color: #e67e22;"' : ''}>Assists</th>
                                <th${currentStatType === 'points' ? ' style="font-weight: bold; color: #e67e22;"' : ''}>Points</th>
                                <th${currentStatType === 'shots' ? ' style="font-weight: bold; color: #e67e22;"' : ''}>Shots</th>
                            `}
                        </tr>
                    </thead>
                    <tbody>
                        ${gameRows}
                    </tbody>
                </table>
            `;

            document.getElementById('gameLogModal').style.display = 'block';
        }

        function calculateH2HStats(allGames, opponentFullName) {
            const teamMappings = {
                'Toronto Maple Leafs': 'TOR',
                'Boston Bruins': 'BOS',
                'Tampa Bay Lightning': 'TBL',
                'Florida Panthers': 'FLA',
                'Montreal Canadiens': 'MTL',
                'Ottawa Senators': 'OTT',
                'Buffalo Sabres': 'BUF',
                'Detroit Red Wings': 'DET',
                'New York Rangers': 'NYR',
                'New York Islanders': 'NYI',
                'New Jersey Devils': 'NJD',
                'Pittsburgh Penguins': 'PIT',
                'Washington Capitals': 'WSH',
                'Philadelphia Flyers': 'PHI',
                'Columbus Blue Jackets': 'CBJ',
                'Carolina Hurricanes': 'CAR',
                'Nashville Predators': 'NSH',
                'Winnipeg Jets': 'WPG',
                'Minnesota Wild': 'MIN',
                'Colorado Avalanche': 'COL',
                'Dallas Stars': 'DAL',
                'Chicago Blackhawks': 'CHI',
                'St. Louis Blues': 'STL',
                'Vegas Golden Knights': 'VGK',
                'Edmonton Oilers': 'EDM',
                'Calgary Flames': 'CGY',
                'Vancouver Canucks': 'VAN',
                'Seattle Kraken': 'SEA',
                'San Jose Sharks': 'SJS',
                'Anaheim Ducks': 'ANA',
                'Los Angeles Kings': 'LAK',
                'Arizona Coyotes': 'ARI',
                'Utah Mammoth': 'UTA',
                'Utah Mammoth': 'UTA'
            };
            
            const opponentAbbrev = teamMappings[opponentFullName];
            
            if (!opponentAbbrev) {
                console.log('Could not find abbreviation for:', opponentFullName);
                return null;
            }
            
            console.log('Looking for games against:', opponentAbbrev);
            
            const h2hGames = allGames.filter(game => game.opponentAbbrev === opponentAbbrev);
            
            console.log('Found', h2hGames.length, 'games against', opponentAbbrev);
            
            if (h2hGames.length === 0) return null;
            
            let totalGoals = 0;
            let totalAssists = 0;
            let totalPoints = 0;
            let totalShots = 0;
            
            h2hGames.forEach(game => {
                totalGoals += game.goals || 0;
                totalAssists += game.assists || 0;
                totalPoints += game.points || 0;
                totalShots += game.shots || 0;
            });
            
            return {
                games: h2hGames.length,
                avgGoals: (totalGoals / h2hGames.length).toFixed(2),
                avgAssists: (totalAssists / h2hGames.length).toFixed(2),
                avgPoints: (totalPoints / h2hGames.length).toFixed(2),
                avgShots: (totalShots / h2hGames.length).toFixed(2),
                totalGoals,
                totalAssists,
                totalPoints,
                opponentAbbrev
            };
        }

        function calculateH2HHitRate(allGames, opponentAbbrev, lineValue) {
            const h2hGames = allGames.filter(game => game.opponentAbbrev === opponentAbbrev);
            
            if (h2hGames.length === 0) return 0;
            
            // Check if these are goalie games
            const isGoalieStats = h2hGames[0].shotsAgainst !== undefined;
            
            let hits = 0;
            h2hGames.forEach(game => {
                let statValue = 0;
                
                if (isGoalieStats) {
                    // Calculate saves for goalies
                    const shotsAgainst = game.shotsAgainst || 0;
                    const goalsAgainst = game.goalsAgainst || 0;
                    statValue = shotsAgainst - goalsAgainst;
                } else {
                    // Calculate based on current stat type for skaters
                    if (currentStatType === 'points') statValue = game.points || 0;
                    else if (currentStatType === 'goals') statValue = game.goals || 0;
                    else if (currentStatType === 'assists') statValue = game.assists || 0;
                    else if (currentStatType === 'shots') statValue = game.shots || 0;
                }
                
                if (statValue > lineValue) hits++;
            });
            
            return (hits / h2hGames.length) * 100;
        }

        async function showTeamLog(teamName, gameName) {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = '<div class="loading">Loading team data...</div>';
            document.getElementById('gameLogModal').style.display = 'block';
            
            // Find team in teamShotData
            const teamStats = teamShotData.find(t => 
                t.teamFullName === teamName || 
                t.abbrev === teamName ||
                t.teamFullName.includes(teamName)
            );
            
            if (!teamStats) {
                modalContent.innerHTML = '<h2>Team not found</h2>';
                return;
            }
            
            // Parse opponent from game string
            const opponent = gameName.replace(teamName, '').replace(' vs ', '').replace(' @ ', '').trim();
            const oppTeamStats = teamShotData.find(t => 
                t.teamFullName === opponent || 
                t.abbrev === opponent ||
                t.teamFullName.includes(opponent)
            );
            
            // Get betting lines for this team - combine main and alternate lines
            const teamOdds = bettingOdds[teamName];
            let allLines = [];
            if (teamOdds) {
                if (teamOdds.team_totals && teamOdds.team_totals.length > 0) {
                    allLines.push(...teamOdds.team_totals);
                }
                if (teamOdds.alternate_team_totals && teamOdds.alternate_team_totals.length > 0) {
                    allLines.push(...teamOdds.alternate_team_totals);
                }
            }
            const mainLine = allLines.length > 0 ? getMainLine(teamOdds.team_totals || allLines) : null;
            const lineValue = mainLine ? mainLine.line : 0;
            
            // Try to fetch team schedule from NHL API
            // We'll need to map team name to team ID first
            const teamNameToId = {
                'Anaheim Ducks': 24, 'Arizona Coyotes': 53, 'Boston Bruins': 6, 'Buffalo Sabres': 7,
                'Calgary Flames': 20, 'Carolina Hurricanes': 12, 'Chicago Blackhawks': 16, 'Colorado Avalanche': 21,
                'Columbus Blue Jackets': 29, 'Dallas Stars': 25, 'Detroit Red Wings': 17, 'Edmonton Oilers': 22,
                'Florida Panthers': 13, 'Los Angeles Kings': 26, 'Minnesota Wild': 30, 'Montreal Canadiens': 8,
                'Nashville Predators': 18, 'New Jersey Devils': 1, 'New York Islanders': 2, 'New York Rangers': 3,
                'Ottawa Senators': 9, 'Philadelphia Flyers': 4, 'Pittsburgh Penguins': 5, 'San Jose Sharks': 28,
                'Seattle Kraken': 55, 'St. Louis Blues': 19, 'Tampa Bay Lightning': 14, 'Toronto Maple Leafs': 10,
                'Utah Hockey Club': 59, 'Utah Mammoth': 59, 'Vancouver Canucks': 23, 'Vegas Golden Knights': 54, 'Washington Capitals': 15,
                'Winnipeg Jets': 52
            };
            
            const teamId = teamNameToId[teamStats.teamFullName] || teamNameToId[teamName];
            
            // Map team to proper NHL 3-letter abbreviation (API returns full names but schedule uses 3-letter codes)
            const teamNameToAbbrev = {
                'Anaheim Ducks': 'ANA', 'Arizona Coyotes': 'ARI', 'Boston Bruins': 'BOS', 'Buffalo Sabres': 'BUF',
                'Calgary Flames': 'CGY', 'Carolina Hurricanes': 'CAR', 'Chicago Blackhawks': 'CHI', 'Colorado Avalanche': 'COL',
                'Columbus Blue Jackets': 'CBJ', 'Dallas Stars': 'DAL', 'Detroit Red Wings': 'DET', 'Edmonton Oilers': 'EDM',
                'Florida Panthers': 'FLA', 'Los Angeles Kings': 'LAK', 'Minnesota Wild': 'MIN', 'Montreal Canadiens': 'MTL',
                'Nashville Predators': 'NSH', 'New Jersey Devils': 'NJD', 'New York Islanders': 'NYI', 'New York Rangers': 'NYR',
                'Ottawa Senators': 'OTT', 'Philadelphia Flyers': 'PHI', 'Pittsburgh Penguins': 'PIT', 'San Jose Sharks': 'SJS',
                'Seattle Kraken': 'SEA', 'St. Louis Blues': 'STL', 'Tampa Bay Lightning': 'TBL', 'Toronto Maple Leafs': 'TOR',
                'Utah Hockey Club': 'UTA', 'Utah Mammoth': 'UTA', 'Vancouver Canucks': 'VAN', 'Vegas Golden Knights': 'VGK', 
                'Washington Capitals': 'WSH', 'Winnipeg Jets': 'WPG'
            };
            
            const teamAbbrev = teamNameToAbbrev[teamStats.teamFullName] || teamNameToAbbrev[teamName] || teamStats.abbrev;
            
            console.log('Team lookup:', { teamName, teamFullName: teamStats.teamFullName, teamId, teamAbbrev });
            
            let games = [];
            let hits = 0;
            
            if (teamId) {
                try {
                    const season = '20252026';
                    const scheduleUrl = `https://api-web.nhle.com/v1/club-schedule-season/${teamId}/${season}`;
                    console.log('Fetching schedule:', scheduleUrl);
                    const response = await fetch(scheduleUrl);
                    const data = await response.json();
                    
                    console.log('Schedule API response:', data);
                    
                    if (data && data.games) {
                        // Filter to completed games and get last 10
                        const completedGames = data.games.filter(g => g.gameState === 'OFF' || g.gameState === 'FINAL');
                        console.log('Completed games:', completedGames.length);
                        
                        games = completedGames
                            .slice(-10)
                            .reverse();
                        
                        console.log('Games to display:', games.length);
                        
                        // Calculate hit rate
                        games.forEach(game => {
                            const teamScore = game.homeTeam.abbrev === teamAbbrev ? game.homeTeam.score : game.awayTeam.score;
                            if (teamScore > lineValue) hits++;
                        });
                    }
                } catch (error) {
                    console.error('Error fetching team schedule:', error);
                    modalContent.innerHTML = `<h2>Error loading team schedule</h2><p>${error.message}</p>`;
                    return;
                }
            } else {
                console.error('No teamId found for:', teamName, teamStats);
                modalContent.innerHTML = `<h2>Team ID not found</h2><p>Could not find team ID for ${teamName}</p>`;
                return;
            }
            
            const hitRate = games.length > 0 ? ((hits / games.length) * 100).toFixed(1) : 0;
            const colorClass = getHitRateColor(parseFloat(hitRate));
            
            // Generate game rows
            const gameRows = games.map(game => {
                const isHome = game.homeTeam.abbrev === teamAbbrev;
                const teamScore = isHome ? game.homeTeam.score : game.awayTeam.score;
                const oppAbbrev = isHome ? game.awayTeam.abbrev : game.homeTeam.abbrev;
                const homeAway = isHome ? 'vs' : '@';
                const [year, month, day] = game.gameDate.split('-');
                const gameDate = new Date(year, month - 1, day).toLocaleDateString();
                const hit = teamScore > lineValue;
                
                return `
                    <tr class="${hit ? 'hit' : 'miss'}">
                        <td>${gameDate}</td>
                        <td>${homeAway} ${oppAbbrev}</td>
                        <td><strong>${teamScore}</strong></td>
                    </tr>
                `;
            }).join('');
            
            // H2H section
            let h2hSection = '';
            if (oppTeamStats && games.length > 0) {
                // Get opponent abbreviation
                const oppAbbrev = teamNameToAbbrev[oppTeamStats.teamFullName] || teamNameToAbbrev[opponent] || oppTeamStats.abbrev;
                
                const h2hGames = games.filter(game => {
                    const gameOppAbbrev = game.homeTeam.abbrev === teamAbbrev ? game.awayTeam.abbrev : game.homeTeam.abbrev;
                    return gameOppAbbrev === oppAbbrev;
                });
                
                if (h2hGames.length > 0) {
                    let h2hHits = 0;
                    const h2hRows = h2hGames.map(game => {
                        const isHome = game.homeTeam.abbrev === teamAbbrev;
                        const teamScore = isHome ? game.homeTeam.score : game.awayTeam.score;
                        const homeAway = isHome ? 'vs' : '@';
                        const [year, month, day] = game.gameDate.split('-');
                        const gameDate = new Date(year, month - 1, day).toLocaleDateString();
                        const hit = teamScore > lineValue;
                        if (hit) h2hHits++;
                        
                        return `
                            <tr class="${hit ? 'hit' : 'miss'}">
                                <td>${gameDate}</td>
                                <td>${homeAway} ${oppAbbrev}</td>
                                <td><strong>${teamScore}</strong></td>
                            </tr>
                        `;
                    }).join('');
                    
                    const h2hHitRate = ((h2hHits / h2hGames.length) * 100).toFixed(1);
                    const h2hColorClass = getHitRateColor(parseFloat(h2hHitRate));
                    
                    h2hSection = `
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--input-border);">
                            <h3>Head-to-Head vs ${oppAbbrev} This Season</h3>
                            <div class="summary-stats" style="margin-bottom: 15px;">
                                <div class="summary-card">
                                    <div class="summary-label">H2H Hit Rate</div>
                                    <div class="summary-value ${h2hColorClass}">${h2hHitRate}%</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-label">H2H Games</div>
                                    <div class="summary-value">${h2hGames.length}</div>
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Opponent</th>
                                        <th>Goals</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${h2hRows}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
            
            modalContent.innerHTML = `
                <h2>${teamName}</h2>
                <p>${gameName}</p>
                
                <div class="summary-stats">
                    <div class="summary-card">
                        <div class="summary-label">Hit Rate (O/U ${lineValue})</div>
                        <div class="summary-value ${colorClass}">${hitRate}%</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Hits</div>
                        <div class="summary-value">${hits}/${games.length}</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Season Avg Goals/Game</div>
                        <div class="summary-value">${teamStats.goalsPerGame.toFixed(1)}</div>
                    </div>
                    ${oppTeamStats ? `
                        <div class="summary-card">
                            <div class="summary-label">${oppTeamStats.abbrev} Allows/Game</div>
                            <div class="summary-value">${oppTeamStats.goalsAgainstPerGame.toFixed(1)}</div>
                        </div>
                    ` : ''}
                </div>
                
                ${allLines.length > 0 ? (() => {
                    // Calculate hit rate for each line
                    const linesWithHitRates = allLines.map(lineObj => {
                        let lineHits = 0;
                        games.forEach(game => {
                            const isHome = game.homeTeam.abbrev === teamStats.abbrev;
                            const teamScore = isHome ? game.homeTeam.score : game.awayTeam.score;
                            if (teamScore > lineObj.line) lineHits++;
                        });
                        
                        const hitRate = games.length > 0 ? ((lineHits / games.length) * 100).toFixed(1) : 0;
                        const colorClass = getHitRateColor(parseFloat(hitRate));
                        
                        return {
                            ...lineObj,
                            hits: lineHits,
                            hitRate,
                            colorClass
                        };
                    });
                    
                    if (linesWithHitRates.length === 1) {
                        // Single line - show traditional card
                        const lineData = linesWithHitRates[0];
                        const overOdds = lineData.overOdds ? (lineData.overOdds > 0 ? `+${lineData.overOdds}` : lineData.overOdds) : null;
                        const underOdds = lineData.underOdds ? (lineData.underOdds > 0 ? `+${lineData.underOdds}` : lineData.underOdds) : null;
                        
                        return `
                            <div class="summary-stats">
                                <div class="summary-card" style="cursor: pointer; grid-column: 1 / -1;">
                                    <div class="summary-label">Betting Line</div>
                                    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 10px; gap: 4px;">
                                        <div style="color: #e67e22; font-size: 2em; font-weight: bold;">${lineData.line}</div>
                                        ${overOdds ? `<div onclick="event.stopPropagation(); addToWatchlist('team-${teamName.replace(/\s+/g, '-')}', '${teamName}', 'team_totals', ${lineData.line}, ${lineData.overOdds}, '${lineData.game}', '${lineData.gameTime}', 'over')" style="color: #27ae60; font-size: 1.3em; font-weight: 600; cursor: pointer; padding: 4px 12px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#27ae60'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#27ae60';">O ${overOdds}</div>` : ''}
                                        ${underOdds ? `<div onclick="event.stopPropagation(); addToWatchlist('team-${teamName.replace(/\s+/g, '-')}', '${teamName}', 'team_totals', ${lineData.line}, ${lineData.underOdds}, '${lineData.game}', '${lineData.gameTime}', 'under')" style="color: #e74c3c; font-size: 1.3em; font-weight: 600; cursor: pointer; padding: 4px 12px; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#e74c3c';">U ${underOdds}</div>` : ''}
                                    </div>
                                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">Click to add to Watchlist</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Multiple lines - show all with hit rates
                        return `
                            <div class="summary-stats">
                                <div class="summary-card" style="grid-column: 1 / -1;">
                                    <div class="collapsible-header" onclick="toggleAvailableLines(this)">
                                        <div class="summary-label">Available Lines (${linesWithHitRates.length}) - Click any line to add to watchlist</div>
                                        <span class="toggle-arrow">▼</span>
                                    </div>
                                    <div class="collapsible-content">
                                        ${linesWithHitRates.map(lineData => {
                                            return `
                                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--card-bg); margin: 5px 0; border-radius: 6px; border-left: 3px solid #e67e22; transition: all 0.2s;">
                                                    <div style="display: flex; align-items: center; gap: 15px;">
                                                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px; gap: 3px;">
                                                            <div style="font-weight: bold; color: #e67e22; font-size: 1.4em;">${lineData.line}</div>
                                                            ${lineData.overOdds ? `<div onclick="event.stopPropagation(); addToWatchlist('team-${teamName.replace(/\s+/g, '-')}', '${teamName}', 'team_totals', ${lineData.line}, ${lineData.overOdds}, '${lineData.game}', '${lineData.gameTime}', 'over')" style="color: #27ae60; font-size: 1em; font-weight: 600; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#27ae60'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#27ae60';">O ${lineData.overOdds > 0 ? '+' : ''}${lineData.overOdds}</div>` : ''}
                                                            ${lineData.underOdds ? `<div onclick="event.stopPropagation(); addToWatchlist('team-${teamName.replace(/\s+/g, '-')}', '${teamName}', 'team_totals', ${lineData.line}, ${lineData.underOdds}, '${lineData.game}', '${lineData.gameTime}', 'under')" style="color: #e74c3c; font-size: 1em; font-weight: 600; cursor: pointer; padding: 2px 8px; border-radius: 3px; transition: all 0.2s;" onmouseover="this.style.background='#e74c3c'; this.style.color='white';" onmouseout="this.style.background=''; this.style.color='#e74c3c';">U ${lineData.underOdds > 0 ? '+' : ''}${lineData.underOdds}</div>` : ''}
                                                        </div>
                                                        <span style="color: var(--text-secondary); font-size: 0.8em;">(${lineData.bookmaker})</span>
                                                    </div>
                                                    <div>
                                                        <span class="${lineData.colorClass}" style="font-weight: bold; font-size: 1em;">${lineData.hitRate}%</span>
                                                        <span style="color: var(--text-secondary); font-size: 0.9em; margin-left: 5px;">(${lineData.hits}/${games.length})</span>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                })() : ''}
                
                <h3 style="margin-top: 30px;">Last ${games.length} Games</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Goals</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${gameRows || '<tr><td colspan="3">No games available</td></tr>'}
                    </tbody>
                </table>
                
                ${h2hSection}
            `;
        }

        function closeModal() {
            document.getElementById('gameLogModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('gameLogModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
